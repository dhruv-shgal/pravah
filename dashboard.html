<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRAVAH â€¢ Biodiversity Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f7faf9; --card: #ffffff; --text: #1f2b2a; --muted:#5c6e6b;
            --primary: #2d8659; --primary-dark:#1b5e42; --border:#e3e8e7; --subtle:#e8f3ef;
        }
        [data-theme="dark"] {
            --bg: #0a1f14; --card: #0f2a1d; --text:#e8f5e9; --muted:#b9d4c7; --border:#214a38; --subtle:#174734;
            --primary:#6ec99d; --primary-dark:#52c093;
        }
        html, body { height:100%; }
        body { font-family: 'Poppins', sans-serif; background:var(--bg); color:var(--text); }
        /* Navbar (shared) */
        .navbar { position: fixed; top:0; width:100%; background:var(--card); box-shadow:0 2px 10px rgba(0,0,0,0.05); z-index:1000; }
        .nav-container { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; padding: 14px 24px; }
        .logo { display:flex; align-items:center; gap:8px; font-weight:700; color:var(--primary); text-decoration:none; }
        .nav-links { display:flex; gap:20px; align-items:center; list-style:none; }
        .nav-links a { color:var(--text); text-decoration:none; font-weight:500; }
        .menu-btn { display:none; width:40px; height:40px; border:1px solid var(--border); border-radius:10px; background:var(--card); align-items:center; justify-content:center; cursor:pointer; }
        .menu-icon { width:18px; height:2px; background: var(--text); position:relative; }
        .menu-icon::before, .menu-icon::after { content:""; position:absolute; left:0; width:100%; height:2px; background: var(--text); }
        .menu-icon::before { top:-6px; }
        .menu-icon::after { top:6px; }
        .nav-links a:hover { color:var(--primary); }
        .toggle-switch { position:relative; width:50px; height:26px; background:var(--muted); border-radius:30px; cursor:pointer; }
        .toggle-slider { position:absolute; top:3px; left:3px; width:20px; height:20px; background:#fff; border-radius:50%; transition: transform .25s ease; }
        .toggle-switch.active { background: var(--primary); }
        .toggle-switch.active .toggle-slider { transform: translateX(24px); }

        .container { max-width: 1200px; margin: 0 auto; padding: 24px; margin-top: 80px; }
        .nav-right { display:flex; align-items:center; gap:12px; }

        .filters { display:grid; grid-template-columns: 1fr 1fr 1.2fr auto; gap:16px; margin-top:20px; }
        .field { display:flex; flex-direction:column; gap:6px; }
        .field label { font-size:12px; color:var(--muted); font-weight:600; }
        .input, .select { width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:10px; background:var(--card); color:var(--text); outline:none; }
        .btn-primary { background:var(--primary); color:#fff; border:none; padding:12px 18px; border-radius:10px; cursor:pointer; font-weight:600; }
        .btn-primary:hover { background:var(--primary-dark); }
        .grid { display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-top:20px; }
        .card { background:var(--card); border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.06); padding:18px; border:1px solid var(--border); }
        .section-title { font-weight:700; font-size:18px; margin-bottom:12px; }
        .hero-card { display:grid; grid-template-columns: 380px 1fr; gap:16px; align-items:center; }
        .hero-img { width:100%; height:240px; object-fit:contain; background: var(--subtle); border-radius:12px; transition: opacity .25s ease; }
        .hero-img.img-loading { opacity: 0.2; background: linear-gradient(90deg, var(--subtle), rgba(255,255,255,0.2), var(--subtle)); background-size: 300% 100%; animation: shimmer 1.2s infinite; }
        @keyframes shimmer { 0%{ background-position: 0% 0; } 100%{ background-position: 100% 0; } }
        .years { color:#e23d3d; font-size:44px; font-weight:800; line-height:1; }
        .muted { color:var(--muted); font-size:13px; }
        .chip { display:inline-block; background:var(--subtle); color:var(--text); padding:6px 10px; border-radius:8px; font-size:12px; margin-top:8px; }
        .key-lines { margin-top:10px; }
        .key-lines div { font-size:13px; margin-top:6px; }
        .stats { display:grid; grid-template-columns: 1fr; gap:12px; }
        .stat-row { display:flex; align-items:center; justify-content:space-between; }
        .progress { height:8px; background:var(--subtle); border-radius:999px; overflow:hidden; width:120px; margin-left:8px; }
        .progress > span { display:block; height:100%; background:var(--primary); }
        .chart-wrap { height:320px; border-radius:10px; border:1px dashed var(--border); display:flex; align-items:center; justify-content:center; padding:10px; position: relative; }
        .chart-wrap canvas { max-width: 100%; max-height: 100%; width: 100% !important; height: 100% !important; }
        .two-col { display:grid; grid-template-columns: 1.7fr 1fr; gap:20px; margin-top:20px; }
        .list { padding-left:18px; }
        .list li { margin:8px 0; }
        .back { text-decoration:none; color:var(--primary); font-weight:600; }
        /* Loading overlay */
        .overlay { position: fixed; inset: 0; display:none; align-items:center; justify-content:center; z-index:10; backdrop-filter: blur(4px); background: rgba(0,0,0,0.15); }
        .overlay .panel { background: var(--card); color: var(--text); width:min(560px, 92vw); border-radius:16px; border:1px solid var(--border); padding:22px; box-shadow:0 24px 64px rgba(0,0,0,0.25); text-align:center; }
        .spinner { width:32px; height:32px; border-radius:50%; border:3px solid var(--subtle); border-top-color: var(--primary); margin:0 auto 14px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fact { font-size:14px; color: var(--muted); margin-top:8px; }
        .blurred { filter: blur(3px); pointer-events:none; user-select:none; }
        @media (max-width: 900px) {
            .filters { grid-template-columns: 1fr; }
            .grid { grid-template-columns: 1fr; }
            .hero-card { grid-template-columns: 1fr; }
            .two-col { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .container { padding: 16px; margin-top: 72px; }
            .nav-links { position:absolute; top:64px; right:16px; left:16px; background:var(--card); border:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,0.08); border-radius:14px; padding:12px; display:none; flex-direction:column; gap:10px; z-index:1001; }
            .nav-links.show { display:flex; }
            .menu-btn { display:inline-flex; }
            .section-title { font-size: 16px; }
            .hero-img { height: 220px; }
            .years { font-size: 36px; }
            .chart-wrap { height: 260px; }
        }

        @media (max-width: 480px) {
            .logo { font-size: 0.95rem; }
            .input, .select { font-size: 14px; }
            .btn-primary { width: 100%; }
            .hero-img { height: 200px; }
            .years { font-size: 32px; }
            .chart-wrap { height: 220px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo"><span>ðŸŒ¿</span><span>PRAVAH</span></a>
            <button class="menu-btn" id="menuBtn"><span class="menu-icon"></span></button>
            <ul class="nav-links" id="mobileMenu">
                <li><a href="index.html#home">Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="eco-connect.html">Eco-Connect</a></li>
                <li><a href="index.html#about">About</a></li>
                <li><a href="index.html#contact">Contact</a></li>
                <li class="toggle-container"><div class="toggle-switch" id="darkToggle"><div class="toggle-slider"></div></div></li>
            </ul>
        </div>
    </nav>
    <div class="container">

        <div class="filters">
            <div class="field">
                <label for="stateSelect">Select State</label>
                <select class="select" id="stateSelect"></select>
            </div>
            <div class="field">
                <label for="categorySelect">Vegetation</label>
                <select class="select" id="categorySelect">
                    <option value="wildlife">Wildlife</option>
                    <option value="aquatic">Aquatic</option>
                </select>
            </div>
            <div class="field">
                <label for="speciesSelect">Species</label>
                <select class="select" id="speciesSelect">
                    <option value="random">Random Species</option>
                </select>
            </div>
            <button class="btn-primary" id="analyzeBtn" disabled>Analyze Species Threat</button>
        </div>

        <div class="grid">
            <div class="card">
                <div class="section-title">Actionable Dashboard</div>
                <div class="hero-card">
                    <img class="hero-img" id="heroImg" src="https://images.unsplash.com/photo-1544551763-7ef42063f34f?q=80&w=800&auto=format&fit=crop" alt="species" />
                    <div>
                        <div style="font-weight:700; color:var(--primary); margin-bottom:6px;" id="speciesCommon">â€”</div>
                        <div class="years" id="yearsValue">â€”</div>
                        <div class="muted">Predicted Years to Extinction</div>
                        <div class="chip" id="dominantThreat">Dominant Threat: â€”</div>
                        <div class="key-lines">
                            <div><strong>Key Conservation Suggestion:</strong> <span id="suggestion">â€”</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="section-title">Species Details</div>
                <div class="stats">
                    <div class="stat-row"><span>Scientific Name</span><strong id="sciName">â€”</strong></div>
                    <div class="stat-row"><span>Dominant Factor</span><strong id="dominantFactor">â€”</strong></div>
                    <div class="stat-row" style="gap:8px;">
                        <span>Dominant Factor Percentage Contribution</span>
                        <div class="progress"><span id="contribBar" style="width:0%"></span></div>
                        <strong id="contribNum">â€”</strong>
                    </div>
                    <div class="stat-row"><span>Current Status</span><strong id="status">â€”</strong></div>
                    <div class="stat-row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                        <span>Interesting Fact</span>
                        <div style="font-size: 13px; color: var(--muted); line-height: 1.4;" id="speciesFact">â€”</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="two-col">
            <div class="card">
                <div class="section-title">Population Trend & Forecast (1970â€“2040)</div>
                <div class="chart-wrap" style="height: 250px;"><canvas id="trendChart" height="220"></canvas></div>
            </div>
            <div class="card">
                <div class="section-title">Species Distribution by Conservation Status</div>
                <div class="chart-wrap" style="height: 250px;"><canvas id="pieChart" height="220"></canvas></div>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="overlay" id="loadingOverlay" role="alert" aria-live="polite">
        <div class="panel">
            <div class="spinner"></div>
            <div style="font-weight:700; margin-bottom:6px;">Analyzing species threatâ€¦</div>
            <div class="fact" id="factText">Crunching habitat and trend signalsâ€¦</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
    <script>
        // THEME: shared with home page via localStorage 'theme'
        (function(){
            const html = document.documentElement;
            const saved = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-theme', saved);
            const t = document.getElementById('darkToggle');
            if (saved === 'dark') t.classList.add('active');
            t.addEventListener('click', function(){
                const cur = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', cur); localStorage.setItem('theme', cur); this.classList.toggle('active');
                if(window._trendChart){ window._trendChart.destroy(); renderChart(_lastSeries.labels, _lastSeries.values); }
            });
            // Mobile menu
            const menuBtn = document.getElementById('menuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            menuBtn.addEventListener('click', function(){ mobileMenu.classList.toggle('show'); });
        })();

        const FILES = { aquatic: 'aquaticlife_dataset.csv', wildlife: 'pva_dynamic_dataset.csv' };
        const STATES = ['Andhra Pradesh','Arunachal Pradesh','Assam','Bihar','Chhattisgarh','Goa','Gujarat','Haryana','Himachal Pradesh','Jharkhand','Karnataka','Kerala','Madhya Pradesh','Maharashtra','Manipur','Meghalaya','Mizoram','Nagaland','Odisha','Punjab','Rajasthan','Sikkim','Tamil Nadu','Telangana','Tripura','Uttar Pradesh','Uttarakhand','West Bengal','Andaman & Nicobar','Chandigarh','Dadra & Nagar Haveli and Daman & Diu','Delhi','Jammu & Kashmir','Ladakh','Lakshadweep','Puducherry'];

        let datasets = { aquatic: [], wildlife: [] };
        let currentDatasetKey = 'aquatic';
        let _lastSeries = { labels: [], values: [] };

        function statusCategory(text){
            const t = (text||'').toLowerCase();
            if (t.includes('critically endangered') || t.includes('(cr)')) return 'CR';
            if (t.includes('endangered')) return 'EN';
            if (t.includes('near threatened')) return 'NT';
            if (t.includes('least concern')) return 'LC';
            if (t.includes('vulnerable')) return 'VU';
            return 'UNK';
        }

        function estimateYearsFromStatus(status){
            switch(statusCategory(status)){
                case 'CR': return 40;
                case 'EN': return 60;
                case 'VU': return 100;
                case 'NT': return 150;
                case 'LC': return 200;
                default: return 120;
            }
        }

        function estimateCorrelationFromThreat(threat, status){
            const s = statusCategory(status);
            let base = 0.5;
            if (s==='CR') base = 0.9; else if (s==='EN') base = 0.8; else if (s==='VU') base = 0.7; else if (s==='NT') base = 0.55; else if (s==='LC') base = 0.4;
            if ((threat||'').toLowerCase().includes('overfishing') || (threat||'').toLowerCase().includes('poaching')) base += 0.05;
            if ((threat||'').toLowerCase().includes('pollution')) base += 0.03;
            return Math.max(0.2, Math.min(0.98, base));
        }

        function normalizeAquatic(row){
            const status = (row['Conservation_Status']||'').replace(/\.$/, '');
            const threat = row['Dominant_Threats'] || '-';
            return {
                common: row['Common_Name'],
                scientific: row['Scientific_Name'],
                status,
                threat,
                suggestion: row['Conservation_Suggestions'] || '-',
                correlation: estimateCorrelationFromThreat(threat, status),
                years: estimateYearsFromStatus(status)
            };
        }
        function normalizeWildlife(row){
            return {
                common: row['Species_Name'],
                scientific: row['Scientific_Name'],
                status: row['Conservation_Status'],
                threat: row['Dominant_Threat_Factor'],
                suggestion: row['Conservation_Suggestion'],
                correlation: parseFloat(row['Correlation_Value']||'0') || 0,
                years: parseInt(row['Years_Max']||'80') || 80,
                population: parseInt(row['N_Current_Pop_Size']||'1000') || 1000,
                fragmentation: parseFloat(row['Threat_Score_Fragmentation']||'0') || 0,
                poaching: parseFloat(row['Threat_Score_Poaching']||'0') || 0,
                conflict: parseFloat(row['Threat_Score_Conflict']||'0') || 0,
                harvest: parseFloat(row['Poaching_Harvest_Rate']||'0') || 0
            };
        }

        function loadCSV(key){
            return new Promise((resolve, reject)=>{
                Papa.parse(FILES[key], {
                    download: true,
                    header: true,
                    complete: (res)=>{
                        const rows = res.data.filter(r=>Object.keys(r).length>1);
                        const normalized = key==='aquatic' ? rows.map(normalizeAquatic) : rows.map(normalizeWildlife);
                        datasets[key] = normalized;
                        resolve(normalized);
                    },
                    error: reject
                });
            });
        }

        function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

        function fillSpeciesOptions(key){
            const sel = document.getElementById('speciesSelect');
            sel.innerHTML = '<option value="random">Random Species</option>' +
                datasets[key].slice(0,300).map((r,i)=>`<option value="${i}">${r.common}</option>`).join('');
        }

        function getExtinctionRange(years) {
            if (years <= 60) {
                return '50-60 YEARS';
            } else if (years <= 70) {
                return '60-70 YEARS';
            } else if (years <= 80) {
                return '70-80 YEARS';
            } else if (years <= 90) {
                return '80-90 YEARS';
            } else if (years <= 100) {
                return '90-100 YEARS';
            } else if (years <= 110) {
                return '100-110 YEARS';
            } else if (years <= 120) {
                return '110-120 YEARS';
            } else if (years <= 130) {
                return '120-130 YEARS';
            } else if (years <= 140) {
                return '130-140 YEARS';
            } else if (years <= 150) {
                return '140-150 YEARS';
            } else if (years <= 160) {
                return '150-160 YEARS';
            } else if (years <= 170) {
                return '160-170 YEARS';
            } else if (years <= 180) {
                return '170-180 YEARS';
            } else if (years <= 190) {
                return '180-190 YEARS';
            } else if (years <= 200) {
                return '190-200 YEARS';
            } else {
                return '200+ YEARS';
            }
        }

        async function getSpeciesFact(speciesName) {
            console.log('Getting fact for species:', speciesName);
            
            const facts = {
                // Wildlife facts - exact matches
                'Lion-tailed Macaque': 'These primates are known for their distinctive mane-like tuft of hair around their face, giving them a lion-like appearance. They are one of the most endangered primates in India.',
                'Bonnet Macaque': 'Named for the cap-like tuft of hair on their heads, these monkeys are highly adaptable and often seen in urban areas across South India.',
                'Nilgiri Langur': 'These langurs are endemic to the Western Ghats and are known for their striking black and silver fur. They play a crucial role in seed dispersal.',
                'Tufted Grey Langur': 'Also known as the Hanuman Langur, they are considered sacred in Hindu mythology and are often found near temples.',
                'Bengal Tiger': 'The national animal of India, these magnificent cats can swim and are known to travel long distances in search of territory.',
                'Indian Elephant': 'These gentle giants have the largest brain of any land animal and are known for their complex social structures and memory.',
                'Leopard': 'These elusive big cats are excellent climbers and can carry prey twice their body weight up trees.',
                'Sloth Bear': 'Despite their name, sloth bears are actually quite fast runners and are the only bears that carry their young on their backs.',
                'Indian Rhinoceros': 'Also called the Greater One-horned Rhinoceros, they have a single horn and are excellent swimmers.',
                'Wild Boar': 'These omnivores have an incredible sense of smell and can run up to 30 mph when threatened.',
                
                // Aquatic facts - exact matches
                'Ganges River Dolphin': 'These blind dolphins use echolocation to navigate and are considered the national aquatic animal of India.',
                'Mugger Crocodile': 'These crocodiles can live up to 50 years and are known for their ability to survive in both fresh and saltwater.',
                'Indian Flapshell Turtle': 'These turtles can retract their heads completely into their shells and are excellent swimmers.',
                'Giant Freshwater Prawn': 'One of the largest freshwater prawns in the world, they can grow up to 30 cm in length.',
                'Indian Major Carp': 'These fish are known for their rapid growth and are important in aquaculture across India.',
                'Hilsa Fish': 'Considered the "king of fish" in Bengal, Hilsa is known for its unique taste and cultural significance.',
                'Mahseer': 'Known as the "tiger of the water," these fish are highly prized by anglers and can grow up to 2 meters in length.',
                'Gharial': 'These crocodilians have the longest snout of any crocodile species and are critically endangered.',
                'Indian Softshell Turtle': 'These turtles can breathe through their skin and are known for their soft, leathery shells.',
                'Gangetic Shark': 'Despite being called a shark, this species is actually a type of catfish and is endemic to the Ganges River system.',
                
                // Additional species with unique facts
                'South-western Langur': 'These langurs are endemic to the Western Ghats and are known for their distinctive black and silver fur. They are excellent seed dispersers.',
                'Common Langur': 'These langurs are highly social animals that live in troops and are known for their loud alarm calls that warn other animals of danger.',
                'Rhesus Macaque': 'These monkeys are highly intelligent and have been used extensively in medical research. They are also excellent swimmers.',
                'Assam Macaque': 'These macaques are found in the northeastern regions of India and are known for their distinctive cheek pouches.',
                'Golden Langur': 'These langurs are critically endangered and are known for their striking golden fur. They are found only in a small region of Assam.',
                'Hoolock Gibbon': 'These are the only apes found in India and are known for their loud, melodious calls that can be heard from miles away.',
                'Indian Pangolin': 'These scaly mammals are the most trafficked animals in the world due to their scales being used in traditional medicine.',
                'Indian Giant Squirrel': 'These squirrels are among the largest in the world and are known for their vibrant, multi-colored fur.',
                'Malabar Giant Squirrel': 'These squirrels are endemic to the Western Ghats and are known for their ability to glide between trees.',
                'Indian Flying Fox': 'These are the largest bats in India and play a crucial role in pollination and seed dispersal.',
                
                // Aquatic species with unique facts
                'Indian Mackerel': 'These fish are known for their distinctive blue-green stripes and are an important commercial fish species.',
                'Pomfret': 'These flatfish are highly prized for their delicate flavor and are often called the "chicken of the sea."',
                'Catla': 'These carp are known for their large size and are one of the most important fish in Indian aquaculture.',
                'Rohu': 'These fish are known for their rapid growth and are widely farmed across India for their nutritional value.',
                'Mrigal': 'These bottom-feeding fish are known for their ability to clean water bodies by feeding on organic matter.',
                'Indian Catfish': 'These fish are known for their whisker-like barbels and are excellent at surviving in low-oxygen conditions.',
                'Snakehead': 'These predatory fish can breathe air and are known for their ability to survive out of water for several days.',
                'Tilapia': 'These fish are known for their rapid reproduction and are widely used in aquaculture worldwide.',
                'Indian Carp': 'These fish are known for their hardiness and are important in maintaining water quality in ponds and lakes.',
                'Freshwater Eel': 'These mysterious fish can travel thousands of kilometers to spawn and are known for their snake-like appearance.'
            };
            
            // Try to find exact match first
            if (facts[speciesName]) {
                console.log('Found exact match for:', speciesName);
                return facts[speciesName];
            }
            
            // Try to find partial match with better logic
            const lowerSpeciesName = speciesName.toLowerCase();
            for (const [key, fact] of Object.entries(facts)) {
                const lowerKey = key.toLowerCase();
                if (lowerSpeciesName.includes(lowerKey) || lowerKey.includes(lowerSpeciesName)) {
                    console.log('Found partial match for:', speciesName, 'matching:', key);
                    return fact;
                }
            }
            
            // Generate unique fact based on species characteristics
            const uniqueFacts = [
                `The ${speciesName} plays a crucial role in maintaining ecological balance through its unique feeding habits and habitat preferences.`,
                `This species of ${speciesName} has evolved remarkable adaptations to survive in its specific environment, making it an important indicator of ecosystem health.`,
                `The ${speciesName} contributes significantly to biodiversity through its interactions with other species and its role in the food web.`,
                `Known for its distinctive characteristics, the ${speciesName} is an essential component of its ecosystem and requires careful conservation efforts.`,
                `The ${speciesName} demonstrates remarkable resilience and adaptability, making it a fascinating subject for ecological studies and conservation research.`
            ];
            
            // Use species name to generate a consistent but unique fact
            const hash = speciesName.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            const factIndex = Math.abs(hash) % uniqueFacts.length;
            
            console.log('Using generated fact for:', speciesName);
            return uniqueFacts[factIndex];
        }

        function renderDetails(item){
            const yearsEl = document.getElementById('yearsValue');
            const threatEl = document.getElementById('dominantThreat');
            const suggestionEl = document.getElementById('suggestion');
            const sciEl = document.getElementById('sciName');
            const commonEl = document.getElementById('speciesCommon');
            const statusEl = document.getElementById('status');
            const contribBarEl = document.getElementById('contribBar');
            const contribNumEl = document.getElementById('contribNum');
            const dominantFactorEl = document.getElementById('dominantFactor');
            const factEl = document.getElementById('speciesFact');
            
            if (yearsEl) yearsEl.textContent = getExtinctionRange(item.years);
            if (threatEl) threatEl.textContent = 'Dominant Threat: ' + (item.threat||'-');
            if (suggestionEl) suggestionEl.textContent = item.suggestion || '-';
            if (sciEl) sciEl.textContent = item.scientific || '-';
            if (commonEl) commonEl.textContent = item.common || 'â€”';
            if (statusEl) statusEl.textContent = item.status || 'â€”';
            
            // Calculate dominant factor percentage based on threat scores
            const threatScores = {
                fragmentation: item.fragmentation || 0,
                poaching: item.poaching || 0,
                conflict: item.conflict || 0,
                harvest: item.harvest || 0
            };
            
            // Find the dominant factor name
            const factorNames = {
                fragmentation: 'Fragmentation',
                poaching: 'Poaching',
                conflict: 'Conflict',
                harvest: 'Harvest Rate'
            };
            
            const maxThreat = Math.max(...Object.values(threatScores));
            const totalThreat = Object.values(threatScores).reduce((a, b) => a + b, 0);
            const dominantFactor = Object.keys(threatScores).find(key => threatScores[key] === maxThreat);
            const pct = totalThreat > 0 ? Math.max(5, Math.min(100, Math.round((maxThreat / totalThreat) * 100))) : 50;
            
            if (contribBarEl) contribBarEl.style.width = pct + '%';
            if (contribNumEl) contribNumEl.textContent = pct.toFixed(1) + '%';
            
            // Display the dominant factor name
            const dominantFactorName = factorNames[dominantFactor] || 'Unknown';
            if (dominantFactorEl) dominantFactorEl.textContent = dominantFactorName;
            
            // Store the dominant factor name for use in pie chart
            item.dominantFactorName = dominantFactorName;
            
            // Get and display species fact
            getSpeciesFact(item.common).then(fact => {
                if (factEl) factEl.textContent = fact;
            });
            
            setSpeciesImage(item);
        }

        function buildSeries(yearsMax, correlation, currentPop){
            const startYear = 1970, endYear = 2040;
            const labels = [];
            const values = [];
            const total = endYear - startYear;
            for (let i=0;i<=total;i++){
                const y = startYear + i;
                const t = i/total;
                const decline = Math.pow(1 - Math.min(0.95, correlation*0.8), t * (80/Math.max(40, Math.min(200, yearsMax))));
                const value = Math.max(50, Math.round(currentPop*decline));
                labels.push(y);
                values.push(value);
            }
            _lastSeries = { labels, values };
            return _lastSeries;
        }

        function renderChart(labels, values){
            const canvas = document.getElementById('trendChart');
            if (!canvas) {
                console.error('trendChart canvas not found');
                return;
            }
            console.log('Rendering line chart with', labels.length, 'data points');
            const ctx = canvas.getContext('2d');
            const dark = document.documentElement.getAttribute('data-theme')==='dark';
            const grid = dark ? 'rgba(185,212,199,0.12)' : 'rgba(0,0,0,0.06)';
            const text = dark ? '#b9d4c7' : '#5a6c7d';
            const border = dark ? '#6ec99d' : '#2d8659';
            const gradient = ctx.createLinearGradient(0,0,0,280);
            gradient.addColorStop(0, dark ? 'rgba(110,201,157,0.35)' : 'rgba(82,192,147,0.35)');
            gradient.addColorStop(1, dark ? 'rgba(27,94,66,0.05)' : 'rgba(82,192,147,0.05)');
            
            if (window._trendChart) window._trendChart.destroy();
            
            try {
                window._trendChart = new Chart(ctx, {
                    type:'line',
                    data:{ 
                        labels, 
                        datasets:[{ 
                            label:'Population Count', 
                            data: values, 
                            borderColor: border, 
                            borderWidth:3, 
                            pointRadius:2, 
                            pointHoverRadius:5, 
                            pointHitRadius:10, 
                            backgroundColor: gradient, 
                            tension:0.35, 
                            fill:true 
                        }]
                    },
                    options:{
                        responsive:true, 
                        maintainAspectRatio:false,
                        interaction:{ mode:'index', intersect:false },
                        scales:{ 
                            x:{ 
                                grid:{ color:grid }, 
                                ticks:{ color:text }, 
                                title:{ display:true, text:'Year', color:text, font:{ weight:'600' } } 
                            }, 
                            y:{ 
                                min:0, 
                                grid:{ color:grid, borderDash:[4,4] }, 
                                ticks:{ color:text, callback:v=>v.toLocaleString() }, 
                                title:{ display:true, text:'Population Count', color:text, font:{ weight:'600' } } 
                            } 
                        },
                        plugins:{ 
                            legend:{ labels:{ color:text } }, 
                            tooltip:{ 
                                backgroundColor: dark?'rgba(20,40,32,0.9)':'rgba(255,255,255,0.95)', 
                                titleColor: dark?'#e8f5e9':'#1f2b2a', 
                                bodyColor: dark?'#b9d4c7':'#2c3e50', 
                                borderColor: grid, 
                                borderWidth:1, 
                                callbacks:{ label:(ctx)=>` ${ctx.parsed.y.toLocaleString()} individuals` } 
                            }, 
                            zoom:{ 
                                pan:{ enabled:true, mode:'xy' }, 
                                zoom:{ wheel:{ enabled:true }, pinch:{ enabled:true }, mode:'xy' } 
                            } 
                        }
                    }
                });
                console.log('Line chart rendered successfully');
            } catch (error) {
                console.error('Error rendering line chart:', error);
            }
        }

        function renderPieChart(dataset, selectedSpecies = null){
            const canvas = document.getElementById('pieChart');
            if (!canvas) {
                console.error('pieChart canvas not found');
                return;
            }
            console.log('Rendering pie chart with', dataset.length, 'species');
            const ctx = canvas.getContext('2d');
            const dark = document.documentElement.getAttribute('data-theme')==='dark';
            const text = dark ? '#b9d4c7' : '#5a6c7d';
            
            // If a specific species is selected, show its threat factors
            if (selectedSpecies && selectedSpecies.fragmentation !== undefined) {
                const threatFactors = {
                    'Fragmentation': selectedSpecies.fragmentation || 0,
                    'Poaching': selectedSpecies.poaching || 0,
                    'Conflict': selectedSpecies.conflict || 0,
                    'Harvest Rate': selectedSpecies.harvest || 0
                };
                
                const labels = Object.keys(threatFactors);
                const data = Object.values(threatFactors);
                const total = data.reduce((a,b) => a + b, 0);
                const colors = ['#e23d3d', '#ff6b35', '#f7931e', '#8bc34a'];
                
                if (window._pieChart) window._pieChart.destroy();
                
                try {
                    window._pieChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels.map((label, index) => {
                                const value = data[index];
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                return `${label}: ${value.toFixed(3)} (${percentage}%)`;
                            }),
                            datasets: [{
                                data: data,
                                backgroundColor: colors.slice(0, labels.length),
                                borderWidth: 2,
                                borderColor: dark ? '#0f2a1d' : '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { 
                                        color: text, 
                                        padding: 10,
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: dark?'rgba(20,40,32,0.9)':'rgba(255,255,255,0.95)',
                                    titleColor: dark?'#e8f5e9':'#1f2b2a',
                                    bodyColor: dark?'#b9d4c7':'#2c3e50',
                                    callbacks: {
                                        label: (ctx) => {
                                            const percentage = total > 0 ? ((ctx.parsed / total) * 100).toFixed(1) : '0.0';
                                            return `${ctx.label}: ${ctx.parsed.toFixed(3)} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log('Pie chart rendered successfully with selected species threat factors');
                    return;
                } catch (error) {
                    console.error('Error rendering pie chart:', error);
                }
            }
            
            // Calculate threat factor averages for endangered species
            const endangeredSpecies = dataset.filter(item => 
                item.status && item.status.toLowerCase().includes('endangered')
            );
            
            if (endangeredSpecies.length === 0) {
                console.log('No endangered species found, showing conservation status instead');
                // Fallback to conservation status if no endangered species
                const statusCounts = {};
                dataset.forEach(item => {
                    let status = item.status || 'Unknown';
                    if (status.toLowerCase().includes('critically endangered')) status = 'Critically Endangered';
                    else if (status.toLowerCase().includes('endangered')) status = 'Endangered';
                    else if (status.toLowerCase().includes('vulnerable')) status = 'Vulnerable';
                    else if (status.toLowerCase().includes('near threatened')) status = 'Near Threatened';
                    else if (status.toLowerCase().includes('least concern')) status = 'Least Concern';
                    else if (status.toLowerCase().includes('data deficient')) status = 'Data Deficient';
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });
                
                const labels = Object.keys(statusCounts);
                const data = Object.values(statusCounts);
                const total = data.reduce((a,b) => a + b, 0);
                const colors = ['#e23d3d', '#ff6b35', '#f7931e', '#8bc34a', '#4caf50', '#2196f3', '#9c27b0'];
                
                if (window._pieChart) window._pieChart.destroy();
                
                window._pieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels.map(label => `${label} (${statusCounts[label]})`),
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: dark ? '#0f2a1d' : '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { 
                                    color: text, 
                                    padding: 10,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: dark?'rgba(20,40,32,0.9)':'rgba(255,255,255,0.95)',
                                titleColor: dark?'#e8f5e9':'#1f2b2a',
                                bodyColor: dark?'#b9d4c7':'#2c3e50',
                                callbacks: {
                                    label: (ctx) => {
                                        const percentage = ((ctx.parsed / total) * 100).toFixed(1);
                                        return `${ctx.label}: ${ctx.parsed} species (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                return;
            }
            
            // Calculate average threat scores for endangered species
            const threatFactors = {
                'Fragmentation': endangeredSpecies.reduce((sum, item) => sum + (parseFloat(item.fragmentation) || 0), 0) / endangeredSpecies.length,
                'Poaching': endangeredSpecies.reduce((sum, item) => sum + (parseFloat(item.poaching) || 0), 0) / endangeredSpecies.length,
                'Conflict': endangeredSpecies.reduce((sum, item) => sum + (parseFloat(item.conflict) || 0), 0) / endangeredSpecies.length,
                'Harvest Rate': endangeredSpecies.reduce((sum, item) => sum + (parseFloat(item.harvest) || 0), 0) / endangeredSpecies.length
            };
            
            const labels = Object.keys(threatFactors);
            const data = Object.values(threatFactors);
            const total = data.reduce((a,b) => a + b, 0);
            const colors = ['#e23d3d', '#ff6b35', '#f7931e', '#8bc34a'];
            
            if (window._pieChart) window._pieChart.destroy();
            
            try {
                window._pieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels.map((label, index) => {
                            const value = data[index];
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toFixed(3)} (${percentage}%)`;
                        }),
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: dark ? '#0f2a1d' : '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { 
                                    color: text, 
                                    padding: 10,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: dark?'rgba(20,40,32,0.9)':'rgba(255,255,255,0.95)',
                                titleColor: dark?'#e8f5e9':'#1f2b2a',
                                bodyColor: dark?'#b9d4c7':'#2c3e50',
                                callbacks: {
                                    label: (ctx) => {
                                        const percentage = ((ctx.parsed / total) * 100).toFixed(1);
                                        return `${ctx.label}: ${ctx.parsed.toFixed(3)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('Pie chart rendered successfully with threat factors');
            } catch (error) {
                console.error('Error rendering pie chart:', error);
            }
        }

        async function ensureLoaded(key){ if (!datasets[key] || datasets[key].length===0) await loadCSV(key); }

        function populateStates(){
            const el = document.getElementById('stateSelect');
            el.innerHTML = STATES.map(s=>`<option value="${s}">${s}</option>`).join('');
            el.value = 'Karnataka';
        }

        async function onSelectionChange(){
            const category = document.getElementById('categorySelect').value; // wildlife or aquatic
            const analyzeBtn = document.getElementById('analyzeBtn');
            // Show same data for all states: wildlife â†’ pva_dynamic dataset, aquatic â†’ aquatic dataset
            if (category === 'wildlife') {
                currentDatasetKey = 'wildlife';
                await ensureLoaded('wildlife');
                fillSpeciesOptions('wildlife');
            } else {
                currentDatasetKey = 'aquatic';
                await ensureLoaded('aquatic');
                fillSpeciesOptions('aquatic');
            }
            analyzeBtn.disabled = false;
        }

        function findMatchByName(list, query){
            const q = (query||'').toLowerCase().trim(); if(!q) return null;
            return list.find(r=> (r.common||'').toLowerCase().includes(q) || (r.scientific||'').toLowerCase().includes(q));
        }

        const FACTS = [
            'Healthy wetlands can store up to 10 times more carbon than forests per unit area.',
            'Wildlife corridors reduce roadkill and reconnect fragmented habitats.',
            'Over 30% of amphibians are threatened globally due to habitat loss and disease.',
            'Mangroves shield coastlines and are nurseries for many fish species.',
            'MPAs (Marine Protected Areas) can double fish biomass within a decade.'
        ];

        function showOverlay(){
            document.getElementById('loadingOverlay').style.display='flex';
            document.querySelector('.container').classList.add('blurred');
            document.getElementById('factText').textContent = FACTS[Math.floor(Math.random()*FACTS.length)];
        }
        function hideOverlay(){
            document.getElementById('loadingOverlay').style.display='none';
            document.querySelector('.container').classList.remove('blurred');
        }

        let _firstLoad = true;
        async function analyze(showLoading = true){
            if (showLoading && !_firstLoad) showOverlay();
            if (!currentDatasetKey) { hideOverlay(); return; }
            await ensureLoaded(currentDatasetKey);
            const list = datasets[currentDatasetKey];
            const speciesSel = document.getElementById('speciesSelect').value;
            let item = null;
            if (speciesSel !== 'random') item = list[parseInt(speciesSel)];
            if (!item) item = pickRandom(list);

            // simulate compute time
            if (showLoading && !_firstLoad) { await new Promise(r=>setTimeout(r, 1200)); }

            renderDetails(item);
            const series = buildSeries(item.years, item.correlation||0.6, item.population||1000);
            // Render charts immediately
            renderChart(series.labels, series.values);
            renderPieChart(datasets[currentDatasetKey], item);
            hideOverlay();
            _firstLoad = false;
        }

        // IMAGE LOOKUP: Wikipedia thumbnail fallback to Unsplash keyword
        async function wikipediaThumb(query){
            if(!query) return null;
            try {
                const res = await fetch('https://en.wikipedia.org/api/rest_v1/page/summary/' + encodeURIComponent(query));
                if(!res.ok) return null;
                const data = await res.json();
                return data && data.thumbnail && data.thumbnail.source ? data.thumbnail.source : null;
            } catch(e){ return null; }
        }

        async function getSpeciesImageUrl(item){
            const bySci = await wikipediaThumb(item.scientific);
            if (bySci) return bySci;
            const byCommon = await wikipediaThumb(item.common);
            if (byCommon) return byCommon;
            return 'https://source.unsplash.com/600x400/?' + encodeURIComponent(item.common || item.scientific || 'wildlife');
        }

        async function setSpeciesImage(item){
            const img = document.getElementById('heroImg');
            if (!img) {
                console.error('heroImg element not found');
                return;
            }
            console.log('Setting species image for:', item.common);
            img.classList.add('img-loading');
            try {
                const url = await getSpeciesImageUrl(item);
                console.log('Image URL:', url);
                return new Promise((resolve)=>{
                    const done = ()=>{ 
                        img.classList.remove('img-loading'); 
                        console.log('Image loaded successfully');
                        resolve(); 
                    };
                    img.onload = done; 
                    img.onerror = (e) => {
                        console.error('Image failed to load:', e);
                        done();
                    }; 
                    img.src = url;
                });
            } catch (error) {
                console.error('Error getting species image:', error);
                img.classList.remove('img-loading');
            }
        }

        // initial load
        (async function init(){
            try {
                console.log('Initializing dashboard...');
                await Promise.all([ensureLoaded('aquatic'), ensureLoaded('wildlife')]);
                console.log('Data loaded:', { aquatic: datasets.aquatic?.length, wildlife: datasets.wildlife?.length });
                populateStates();
                document.getElementById('categorySelect').value = 'wildlife';
                await onSelectionChange();
                
                // Show a random species on startup
                console.log('Loading random species on startup...');
                await analyze(false); // Load without showing loading screen
                
                // Do not auto-analyze on first load; wait for user click
                document.getElementById('stateSelect').addEventListener('change', onSelectionChange);
                document.getElementById('categorySelect').addEventListener('change', onSelectionChange);
                // Only analyze on explicit button click
                document.getElementById('analyzeBtn').addEventListener('click', function(){ analyze(true); });
                console.log('Dashboard initialized successfully');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
            }
        })();
    </script>
</body>
</html>



