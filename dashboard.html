<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRAVAH ‚Ä¢ Biodiversity Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f7faf9; --card: #ffffff; --text: #1f2b2a; --muted:#5c6e6b;
            --primary: #2d8659; --primary-dark:#1b5e42; --border:#e3e8e7; --subtle:#e8f3ef;
        }
        [data-theme="dark"] {
            --bg: #0a1f14; --card: #0f2a1d; --text:#e8f5e9; --muted:#b9d4c7; --border:#214a38; --subtle:#174734;
            --primary:#6ec99d; --primary-dark:#52c093;
        }
        html, body { height:100%; }
        body { font-family: 'Poppins', sans-serif; background:var(--bg); color:var(--text); }
        /* Navbar (shared) */
        .navbar { position: fixed; top:0; width:100%; background:var(--card); box-shadow:0 2px 10px rgba(0,0,0,0.05); z-index:1000; }
        .nav-container { max-width:1400px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; padding: 16px 32px; }
        .logo { display:flex; align-items:center; gap:8px; font-weight:700; color:var(--primary); text-decoration:none; font-size:20px; }
        .nav-links { display:flex; gap:20px; align-items:center; list-style:none; }
        .nav-links a { color:var(--text); text-decoration:none; font-weight:500; font-size:16px; }
        .back-home-btn { 
            background: var(--primary) !important; 
            color: white !important; 
            padding: 8px 16px !important; 
            border-radius: 8px !important; 
            transition: all 0.3s ease !important;
        }
        .back-home-btn:hover { 
            background: var(--primary-dark) !important; 
            transform: translateY(-2px) !important;
        }
        .menu-btn { display:none; width:40px; height:40px; border:1px solid var(--border); border-radius:10px; background:var(--card); align-items:center; justify-content:center; cursor:pointer; }
        .menu-icon { width:18px; height:2px; background: var(--text); position:relative; }
        .menu-icon::before, .menu-icon::after { content:""; position:absolute; left:0; width:100%; height:2px; background: var(--text); }
        .menu-icon::before { top:-6px; }
        .menu-icon::after { top:6px; }
        .nav-links a:hover { color:var(--primary); }
        .toggle-switch { position:relative; width:50px; height:26px; background:var(--muted); border-radius:30px; cursor:pointer; }
        .toggle-slider { position:absolute; top:3px; left:3px; width:20px; height:20px; background:#fff; border-radius:50%; transition: transform .25s ease; }
        .toggle-switch.active { background: var(--primary); }
        .toggle-switch.active .toggle-slider { transform: translateX(24px); }

        .container { max-width: 1400px; margin: 0 auto; padding: 32px; margin-top: 80px; }
        .nav-right { display:flex; align-items:center; gap:12px; }

        .filters { display:grid; grid-template-columns: 1fr 1fr 1.2fr auto; gap:20px; margin-top:24px; }
        .field { display:flex; flex-direction:column; gap:6px; }
        .field label { font-size:14px; color:var(--muted); font-weight:600; }
        .input, .select { width:100%; padding:14px 16px; border:1px solid var(--border); border-radius:10px; background:var(--card); color:var(--text); outline:none; font-size:15px; }
        .btn-primary { background:var(--primary); color:#fff; border:none; padding:14px 22px; border-radius:10px; cursor:pointer; font-weight:600; font-size:16px; }
        .btn-primary:hover { background:var(--primary-dark); }
        .grid { display:grid; grid-template-columns: 2fr 1fr; gap:28px; margin-top:24px; }
        .card { background:var(--card); border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.06); padding:24px; border:1px solid var(--border); }
        .section-title { font-weight:700; font-size:22px; margin-bottom:16px; }
        .hero-card { display:grid; grid-template-columns: 420px 1fr; gap:24px; align-items:center; }
        .hero-img { width:100%; height:280px; object-fit:contain; background: var(--subtle); border-radius:12px; transition: opacity .25s ease; }
        .hero-img.img-loading { opacity: 0.2; background: linear-gradient(90deg, var(--subtle), rgba(255,255,255,0.2), var(--subtle)); background-size: 300% 100%; animation: shimmer 1.2s infinite; }
        @keyframes shimmer { 0%{ background-position: 0% 0; } 100%{ background-position: 100% 0; } }
        .years { color:#e23d3d; font-size:52px; font-weight:800; line-height:1; }
        .muted { color:var(--muted); font-size:15px; }
        .chip { display:inline-block; background:var(--subtle); color:var(--text); padding:8px 14px; border-radius:8px; font-size:14px; margin-top:8px; }
        .key-lines { margin-top:10px; }
        .key-lines div { font-size:15px; margin-top:8px; }
        .stats { display:grid; grid-template-columns: 1fr; gap:16px; font-size:16px; }
        .stat-row { display:flex; align-items:center; justify-content:space-between; padding:4px 0; }
        .progress { height:8px; background:var(--subtle); border-radius:999px; overflow:hidden; width:120px; margin-left:8px; }
        .progress > span { display:block; height:100%; background:var(--primary); }
        .chart-wrap { height:380px; border-radius:10px; border:1px dashed var(--border); display:flex; align-items:center; justify-content:center; padding:12px; position: relative; }
        .chart-wrap canvas { max-width: 100%; max-height: 100%; width: 100% !important; height: 100% !important; }
        
        /* Fact loading spinner animation */
        .fact-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #e0e0e0;
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: fact-spin 1s linear infinite;
        }
        
        @keyframes fact-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        [data-theme="dark"] .fact-spinner {
            border: 2px solid #404040;
            border-top: 2px solid #66BB6A;
        }
        .two-col { display:grid; grid-template-columns: 1fr 1.2fr; gap:28px; margin-top:24px; }
        .three-col { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:28px; margin-top:24px; }
        .simulator-panel { background:var(--card); border:1px solid var(--border); border-radius:12px; padding:20px; margin-top:20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .simulator-panel h3 { color: var(--primary); margin-bottom: 10px; }
        .simulator-panel h4 { color: var(--text); margin-bottom: 15px; font-size: 16px; }
        .slider-label span { color: var(--text); font-weight: 500; }
        .impact-summary { background: var(--subtle); border-radius: 8px; padding: 15px; margin-top: 15px; }
        .impact-summary h4 { color: var(--primary); margin: 0 0 10px 0; }
        .impact-summary div { color: var(--text); }
        .slider-group { margin:15px 0; }
        .slider-label { display:flex; justify-content:space-between; margin-bottom:8px; font-weight:500; }
        .slider { width:100%; height:6px; border-radius:3px; background:var(--subtle); outline:none; }
        .slider::-webkit-slider-thumb { appearance:none; width:18px; height:18px; border-radius:50%; background:var(--primary); cursor:pointer; }
        .slider::-moz-range-thumb { width:18px; height:18px; border-radius:50%; background:var(--primary); cursor:pointer; border:none; }
        .risk-meter { width:200px; height:20px; border-radius:10px; background:linear-gradient(90deg, #4CAF50 0%, #FFC107 50%, #F44336 100%); position:relative; margin:10px 0; }
        .risk-indicator { position:absolute; top:-5px; width:4px; height:30px; background:white; border-radius:2px; transition:left 0.3s ease; }
        .impact-summary { background:var(--subtle); border-radius:8px; padding:15px; margin-top:15px; }
        .trend-arrow { font-size:18px; margin:0 5px; }
        .heatmap-container { width:100%; height:600px; position:relative; }
        .heatmap-cell { position:absolute; border:1px solid rgba(255,255,255,0.3); display:flex; align-items:center; justify-content:center; font-size:10px; font-weight:bold; }
        .list { padding-left:18px; }
        .list li { margin:8px 0; }
        .back { text-decoration:none; color:var(--primary); font-weight:600; }
        /* Loading overlay */
        .overlay { position: fixed; inset: 0; display:none; align-items:center; justify-content:center; z-index:10; backdrop-filter: blur(4px); background: rgba(0,0,0,0.15); }
        .overlay .panel { background: var(--card); color: var(--text); width:min(560px, 92vw); border-radius:16px; border:1px solid var(--border); padding:22px; box-shadow:0 24px 64px rgba(0,0,0,0.25); text-align:center; }
        .spinner { width:32px; height:32px; border-radius:50%; border:3px solid var(--subtle); border-top-color: var(--primary); margin:0 auto 14px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fact { font-size:14px; color: var(--muted); margin-top:8px; }
        .blurred { filter: blur(3px); pointer-events:none; user-select:none; }
        @media (max-width: 900px) {
            .filters { grid-template-columns: 1fr; }
            .grid { grid-template-columns: 1fr; }
            .hero-card { grid-template-columns: 1fr; }
            .two-col { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .container { padding: 16px; margin-top: 72px; }
            .nav-links { position:absolute; top:64px; right:16px; left:16px; background:var(--card); border:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,0.08); border-radius:14px; padding:12px; display:none; flex-direction:column; gap:10px; z-index:1001; }
            .nav-links.show { display:flex; }
            .menu-btn { display:inline-flex; }
            .section-title { font-size: 16px; }
            .hero-img { height: 220px; }
            .years { font-size: 36px; }
            .chart-wrap { height: 260px; }
        }

        @media (max-width: 480px) {
            .logo { font-size: 0.95rem; }
            .input, .select { font-size: 14px; }
            .btn-primary { width: 100%; }
            .hero-img { height: 200px; }
            .years { font-size: 32px; }
            .chart-wrap { height: 220px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="/" class="logo"><span>üåø</span><span>PRAVAH</span></a>
            <button class="menu-btn" id="menuBtn"><span class="menu-icon"></span></button>
            <ul class="nav-links" id="mobileMenu">
                <li><a href="index.html" class="back-home-btn">üè† Back to Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="#" onclick="window.open('https://your-eco-connect-site.vercel.app', '_blank'); return false;">Eco-Connect</a></li>
                <li><a href="index.html#about">About</a></li>
                <li><a href="index.html#contact">Contact</a></li>
                <li class="toggle-container"><div class="toggle-switch" id="darkToggle"><div class="toggle-slider"></div></div></li>
            </ul>
        </div>
    </nav>
    <div class="container">

        <div class="filters">
            <div class="field">
                <label for="stateSelect">Select State</label>
                <select class="select" id="stateSelect"></select>
            </div>
            <div class="field">
                <label for="categorySelect">Vegetation</label>
                <select class="select" id="categorySelect">
                    <option value="wildlife">Wildlife</option>
                    <option value="aquatic">Aquatic</option>
                </select>
            </div>
            <div class="field">
                <label for="speciesSelect">Species</label>
                <select class="select" id="speciesSelect">
                    <option value="random">Random Species</option>
                </select>
            </div>
            <button class="btn-primary" id="analyzeBtn" disabled>Analyze Species Threat</button>
        </div>

        <div class="grid">
            <div class="card">
                <div class="section-title">Actionable Dashboard</div>
                <div class="hero-card">
                    <img class="hero-img" id="heroImg" src="https://images.unsplash.com/photo-1544551763-7ef42063f34f?q=80&w=800&auto=format&fit=crop" alt="species" />
                    <div>
                        <div style="font-weight:700; color:var(--primary); margin-bottom:8px; font-size:20px;" id="speciesCommon">‚Äî</div>
                        <div class="years" id="yearsValue">‚Äî</div>
                        <div class="muted">Predicted Years to Extinction</div>
                        <div class="chip" id="dominantThreat">Dominant Threat: ‚Äî</div>
                        <div class="key-lines">
                            <div><strong>Key Conservation Suggestion:</strong> <span id="suggestion">‚Äî</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="section-title">Species Details</div>
                <div class="stats">
                    <div class="stat-row"><span>Scientific Name</span><strong id="sciName">‚Äî</strong></div>
                    <div class="stat-row"><span>Dominant Factor</span><strong id="dominantFactor">‚Äî</strong></div>
                    <div class="stat-row" style="gap:8px;">
                        <span>Dominant Factor Percentage Contribution</span>
                        <div class="progress"><span id="contribBar" style="width:0%"></span></div>
                        <strong id="contribNum">‚Äî</strong>
                    </div>
                    <div class="stat-row"><span>Current Status</span><strong id="status">‚Äî</strong></div>
                    <div class="stat-row"><span>Population Size</span><strong id="populationSize">‚Äî</strong></div>
                    <div class="stat-row"><span>Extinction Risk</span><strong id="extinctionRisk">‚Äî</strong></div>
                    <div class="stat-row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                        <span>Conservation Priority</span>
                        <div style="font-size: 16px; color: var(--muted); line-height: 1.4;" id="conservationInfo">‚Äî</div>
                    </div>
                    <div class="stat-row" style="flex-direction: column; align-items: flex-start; gap: 4px;">
                        <span>Interesting Fact</span>
                        <div style="font-size: 16px; color: var(--muted); line-height: 1.4;" id="speciesFact">‚Äî</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced Visualization Section -->
        <div class="card">
            <div class="section-title">Population Projection Analysis</div>
            <div class="chart-wrap" style="height: 400px;">
                <canvas id="populationProjectionChart"></canvas>
            </div>
            <div style="display: flex; gap: 20px; margin-top: 15px; font-size: 16px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 12px; height: 12px; background: #4CAF50; border-radius: 2px;"></div>
                    <span>Stable Population</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 12px; height: 12px; background: #FFC107; border-radius: 2px;"></div>
                    <span>Moderate Risk</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <div style="width: 12px; height: 12px; background: #F44336; border-radius: 2px;"></div>
                    <span>High Extinction Risk</span>
                </div>
            </div>
        </div>

        <!-- Threat Breakdown Analysis - Full Width -->
        <div class="card" style="margin-top: 20px;">
            <div class="section-title">Threat Breakdown Analysis</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Left Column: Chart -->
                <div>
                    <div class="chart-wrap" style="height: 400px;">
                        <canvas id="threatBreakdownChart"></canvas>
                    </div>
                </div>
                
                <!-- Right Column: Analysis Content -->
                <div>
                    <!-- Threat Analysis Insights -->
                    <div style="padding: 18px; background: var(--subtle); border-radius: 8px; font-size: 16px; margin-bottom: 18px;">
                        <h4 style="margin: 0 0 10px 0; color: var(--primary);">üéØ Threat Analysis Insights:</h4>
                        <div id="threatInsights" style="line-height: 1.5;">
                            <div class="insight-item" style="margin: 8px 0; padding: 8px; background: var(--card); border-radius: 6px; border-left: 3px solid var(--primary);">
                                <strong>Primary Threat:</strong> <span id="primaryThreatText">Loading...</span>
                            </div>
                            <div class="insight-item" style="margin: 8px 0; padding: 8px; background: var(--card); border-radius: 6px; border-left: 3px solid #FF9800;">
                                <strong>Secondary Threat:</strong> <span id="secondaryThreatText">Loading...</span>
                            </div>
                            <div class="insight-item" style="margin: 8px 0; padding: 8px; background: var(--card); border-radius: 6px; border-left: 3px solid #4CAF50;">
                                <strong>Threat Diversity:</strong> <span id="threatDiversityText">Loading...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Stats -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <div style="padding: 12px; background: var(--subtle); border-radius: 8px; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold; color: var(--primary);" id="threatCount">0</div>
                            <div style="font-size: 14px; color: var(--muted);">Active Threats</div>
                        </div>
                        <div style="padding: 12px; background: var(--subtle); border-radius: 8px; text-align: center;">
                            <div style="font-size: 22px; font-weight: bold; color: var(--primary);" id="riskScore">0%</div>
                            <div style="font-size: 14px; color: var(--muted);">Risk Score</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Full Width Content Below -->
            <div style="margin-top: 20px;">
                <!-- Conservation Action Plan -->
                <div style="padding: 15px; background: var(--subtle); border-radius: 8px; font-size: 14px; margin-bottom: 15px;">
                    <h4 style="margin: 0 0 10px 0; color: var(--primary);">üõ°Ô∏è Recommended Actions:</h4>
                    <div id="actionPlan" style="line-height: 1.5; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="action-priority">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="background: #F44336; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">HIGH</span>
                                <strong>Priority</strong>
                            </div>
                            <div style="font-size: 12px; color: var(--text);" id="highPriorityAction">Loading...</div>
                        </div>
                        <div class="action-priority">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="background: #FF9800; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">MED</span>
                                <strong>Priority</strong>
                            </div>
                            <div style="font-size: 12px; color: var(--text);" id="mediumPriorityAction">Loading...</div>
                        </div>
                        <div class="action-priority">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span style="background: #4CAF50; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold;">LOW</span>
                                <strong>Priority</strong>
                            </div>
                            <div style="font-size: 12px; color: var(--text);" id="lowPriorityAction">Loading...</div>
                        </div>
                    </div>
                </div>
                
                <!-- Conservation Impact Tracker -->
                <div style="padding: 15px; background: var(--subtle); border-radius: 8px; font-size: 14px;">
                    <h4 style="margin: 0 0 15px 0; color: var(--primary);">üåç Conservation Impact Tracker</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                        <!-- Species Comparison -->
                        <div>
                            <h5 style="margin: 0 0 8px 0; color: var(--text); font-size: 13px;">üìä Species Risk Comparison</h5>
                            <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                                <div style="padding: 8px; background: var(--card); border-radius: 6px; text-align: center; border-left: 3px solid #F44336;">
                                    <div style="font-size: 16px; font-weight: bold; color: #F44336;" id="criticalSpeciesCount">0</div>
                                    <div style="font-size: 10px; color: var(--muted);">Critical Risk</div>
                                </div>
                                <div style="padding: 8px; background: var(--card); border-radius: 6px; text-align: center; border-left: 3px solid #FF9800;">
                                    <div style="font-size: 16px; font-weight: bold; color: #FF9800;" id="highRiskCount">0</div>
                                    <div style="font-size: 10px; color: var(--muted);">High Risk</div>
                                </div>
                                <div style="padding: 8px; background: var(--card); border-radius: 6px; text-align: center; border-left: 3px solid #4CAF50;">
                                    <div style="font-size: 16px; font-weight: bold; color: #4CAF50;" id="stableSpeciesCount">0</div>
                                    <div style="font-size: 10px; color: var(--muted);">Stable</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conservation Success Metrics -->
                        <div>
                            <h5 style="margin: 0 0 8px 0; color: var(--text); font-size: 13px;">üéØ Conservation Success</h5>
                            <div style="padding: 10px; background: var(--card); border-radius: 6px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 12px; color: var(--muted);">Population Trend</span>
                                    <span style="font-size: 14px; font-weight: bold;" id="populationTrend">üìà Stable</span>
                                </div>
                            </div>
                            <div style="padding: 10px; background: var(--card); border-radius: 6px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 12px; color: var(--muted);">Habitat Quality</span>
                                    <span style="font-size: 14px; font-weight: bold;" id="habitatQuality">üü¢ Good</span>
                                </div>
                            </div>
                            
                            <!-- Ecosystem Health -->
                            <div style="margin-top: 15px;">
                                <h5 style="margin: 0 0 8px 0; color: var(--text); font-size: 13px;">üåø Ecosystem Health</h5>
                                <div style="background: var(--card); border-radius: 6px; padding: 10px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-size: 12px;">Biodiversity Index</span>
                                        <span style="font-size: 12px; font-weight: bold;" id="biodiversityIndex">75%</span>
                                    </div>
                                    <div style="width: 100%; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;">
                                        <div id="biodiversityBar" style="height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); width: 75%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Conservation Timeline -->
                        <div>
                            <h5 style="margin: 0 0 8px 0; color: var(--text); font-size: 13px;">‚è±Ô∏è Recommended Timeline</h5>
                            <div style="background: var(--card); border-radius: 6px; padding: 10px;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <div style="width: 8px; height: 8px; background: #F44336; border-radius: 50%;"></div>
                                    <span style="font-size: 11px; color: var(--muted);">Immediate:</span>
                                </div>
                                <div style="font-size: 11px; margin-bottom: 8px;" id="immediateAction">Emergency intervention</div>
                                
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <div style="width: 8px; height: 8px; background: #FF9800; border-radius: 50%;"></div>
                                    <span style="font-size: 11px; color: var(--muted);">Short-term:</span>
                                </div>
                                <div style="font-size: 11px; margin-bottom: 8px;" id="shortTermAction">Habitat restoration</div>
                                
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <div style="width: 8px; height: 8px; background: #4CAF50; border-radius: 50%;"></div>
                                    <span style="font-size: 11px; color: var(--muted);">Long-term:</span>
                                </div>
                                <div style="font-size: 11px;" id="longTermAction">Population monitoring</div>
                            </div>
                            
                            <!-- Related Species Alert -->
                            <div style="margin-top: 15px; padding: 12px; background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(139, 195, 74, 0.1)); border-radius: 8px; border-left: 4px solid var(--primary);">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                    <span style="font-size: 16px;">üîó</span>
                                    <h5 style="margin: 0; color: var(--primary); font-size: 13px;">Related Species</h5>
                                </div>
                                <div style="font-size: 12px; color: var(--text); line-height: 1.4;" id="relatedSpeciesInfo">
                                    Similar species may face comparable threats.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Policy Intervention Simulator -->
        <div class="simulator-panel">
            <h3>üîß Policy Intervention Simulator</h3>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Adjust threat levels and habitat quality to see real-time impact on extinction risk</p>
            
            <div class="three-col">
                <div>
                    <h4>Threat Reduction</h4>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Habitat Fragmentation</span>
                            <span id="fragmentationValue">0.5</span>
                        </div>
                        <input type="range" class="slider" id="fragmentationSlider" min="0" max="1" step="0.01" value="0.5">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Poaching/Overfishing</span>
                            <span id="poachingValue">0.5</span>
                        </div>
                        <input type="range" class="slider" id="poachingSlider" min="0" max="1" step="0.01" value="0.5">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Climate Change</span>
                            <span id="climateValue">0.5</span>
                        </div>
                        <input type="range" class="slider" id="climateSlider" min="0" max="1" step="0.01" value="0.5">
                    </div>
                </div>
                
                <div>
                    <h4>Habitat Quality</h4>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Habitat Quality</span>
                            <span id="habitatValue">0.5</span>
                        </div>
                        <input type="range" class="slider" id="habitatSlider" min="0" max="1" step="0.01" value="0.5">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>Population Growth Rate</span>
                            <span id="growthValue">0.5</span>
                        </div>
                        <input type="range" class="slider" id="growthSlider" min="0" max="1" step="0.01" value="0.5">
                    </div>
                </div>
                
                <div>
                    <h4>Risk Assessment</h4>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: bold; margin: 10px 0;" id="extinctionYears">
                            -- years
                        </div>
                        <div class="risk-meter">
                            <div class="risk-indicator" id="riskIndicator"></div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                            Extinction Probability: <span id="extinctionProbability">--%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="impact-summary" id="impactSummary">
                <h4>Intervention Impact Analysis</h4>
                <div id="impactText">Adjust sliders to see intervention impact</div>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="overlay" id="loadingOverlay" role="alert" aria-live="polite">
        <div class="panel">
            <div class="spinner"></div>
            <div style="font-weight:700; margin-bottom:6px;">Analyzing species threat‚Ä¶</div>
            <div class="fact" id="factText">Crunching habitat and trend signals‚Ä¶</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
    <script>
        // THEME: shared with home page via localStorage 'theme'
        (function(){
            const html = document.documentElement;
            const saved = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-theme', saved);
            const t = document.getElementById('darkToggle');
            if (saved === 'dark') t.classList.add('active');
            t.addEventListener('click', function(){
                const cur = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', cur); localStorage.setItem('theme', cur); this.classList.toggle('active');
                if(window._trendChart){ window._trendChart.destroy(); renderChart(_lastSeries.labels, _lastSeries.values); }
            });
            // Mobile menu
            const menuBtn = document.getElementById('menuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            menuBtn.addEventListener('click', function(){ mobileMenu.classList.toggle('show'); });
        })();

        const FILES = { aquatic: 'enhanced_aquatic_dataset_final_clean.csv', wildlife: 'pva_dynamic_dataset.csv' };
        // Remote facts API via OpenRouter (LLM) using user's key
        const FACTS_API_URL = 'https://openrouter.ai/api/v1/chat/completions';
        const FACTS_API_KEY = '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';
        // CORS proxy for local development
        const CORS_PROXY = 'https://cors-anywhere.herokuapp.com/';
        // Cache last facts per species to avoid repeats
        const LAST_FACT_BY_SPECIES = {};
        
        // Test API connection
        async function testAPI() {
            try {
                console.log('Testing API connection...');
                const res = await fetch(FACTS_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + FACTS_API_KEY
                    },
                    body: JSON.stringify({
                        model: 'openrouter/auto',
                        messages: [{ role: 'user', content: 'Test' }],
                        max_tokens: 10
                    })
                });
                console.log('API test response:', res.status, res.statusText);
                return res.ok;
            } catch (e) {
                console.error('API test failed:', e);
                return false;
            }
        }
        const STATES = ['Andhra Pradesh','Arunachal Pradesh','Assam','Bihar','Chhattisgarh','Goa','Gujarat','Haryana','Himachal Pradesh','Jharkhand','Karnataka','Kerala','Madhya Pradesh','Maharashtra','Manipur','Meghalaya','Mizoram','Nagaland','Odisha','Punjab','Rajasthan','Sikkim','Tamil Nadu','Telangana','Tripura','Uttar Pradesh','Uttarakhand','West Bengal','Andaman & Nicobar','Chandigarh','Dadra & Nagar Haveli and Daman & Diu','Delhi','Jammu & Kashmir','Ladakh','Lakshadweep','Puducherry'];

        let datasets = { aquatic: [], wildlife: [] };
        let currentDatasetKey = 'aquatic';
        let _lastSeries = { labels: [], values: [] };

        function statusCategory(text){
            const t = (text||'').toLowerCase();
            if (t.includes('critically endangered') || t.includes('(cr)')) return 'CR';
            if (t.includes('endangered')) return 'EN';
            if (t.includes('near threatened')) return 'NT';
            if (t.includes('least concern')) return 'LC';
            if (t.includes('vulnerable')) return 'VU';
            return 'UNK';
        }

        function estimateYearsFromStatus(status){
            switch(statusCategory(status)){
                case 'CR': return 40;
                case 'EN': return 60;
                case 'VU': return 100;
                case 'NT': return 150;
                case 'LC': return 200;
                default: return 120;
            }
        }

        function estimateCorrelationFromThreat(threat, status){
            const s = statusCategory(status);
            let base = 0.5;
            if (s==='CR') base = 0.9; else if (s==='EN') base = 0.8; else if (s==='VU') base = 0.7; else if (s==='NT') base = 0.55; else if (s==='LC') base = 0.4;
            if ((threat||'').toLowerCase().includes('overfishing') || (threat||'').toLowerCase().includes('poaching')) base += 0.05;
            if ((threat||'').toLowerCase().includes('pollution')) base += 0.03;
            return Math.max(0.2, Math.min(0.98, base));
        }

        function normalizeAquatic(row){
            // Map new enhanced aquatic dataset columns
            const status = (row['Conservation_Status']||'').replace(/\.$/, '');
            const threat = row['Dominant_Threat_Factor'] || row['Dominant_Threats'] || '-';
            return {
                common: row['Species_Name'] || row['Common_Name'],
                scientific: row['Scientific_Name'],
                status,
                threat,
                dominantThreat: threat, // Add for consistency with wildlife data
                suggestion: row['Conservation_Suggestions_Detailed'] || row['Conservation_Suggestions'] || '-',
                correlation: estimateCorrelationFromThreat(threat, status),
                years: estimateYearsFromStatus(status),
                population: parseFloat(row['N_Current_Pop_Size']||'0') || 0,
                envStochasticity: parseFloat(row['Es_Environmental_Stochasticity']||'0') || 0,
                habitatQuality: parseFloat(row['Habitat_Quality_Index']||'0') || 0,
                pollution: parseFloat(row['Threat_Score_Pollution']||'0') || 0,
                overfishing: parseFloat(row['Threat_Score_Overfishing']||'0') || 0,
                climateChange: parseFloat(row['Threat_Score_ClimateChange']||'0') || 0,
                overharvest: parseFloat(row['Overharvest_Rate']||'0') || 0
            };
        }
        function normalizeWildlife(row){
            return {
                common: row['Species_Name'],
                scientific: row['Scientific_Name'],
                status: row['Conservation_Status'],
                threat: row['Dominant_Threat_Factor'],
                dominantThreat: row['Dominant_Threat_Factor'],
                suggestion: row['Conservation_Suggestion'],
                correlation: parseFloat(row['Correlation_Value']||'0') || 0,
                years: parseInt(row['Years_Max']||'80') || 80,
                population: parseInt(row['N_Current_Pop_Size']||'1000') || 1000,
                fragmentation: parseFloat(row['Threat_Score_Fragmentation']||'0') || 0,
                poaching: parseFloat(row['Threat_Score_Poaching']||'0') || 0,
                conflict: parseFloat(row['Threat_Score_Conflict']||'0') || 0,
                harvest: parseFloat(row['Poaching_Harvest_Rate']||'0') || 0
            };
        }

        function loadCSV(key){
            return new Promise((resolve, reject)=>{
                Papa.parse(FILES[key], {
                    download: true,
                    header: true,
                    complete: (res)=>{
                        const rows = res.data.filter(r=>Object.keys(r).length>1);
                        const normalized = key==='aquatic' ? rows.map(normalizeAquatic) : rows.map(normalizeWildlife);
                        datasets[key] = normalized;
                        resolve(normalized);
                    },
                    error: reject
                });
            });
        }

        function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

        function fillSpeciesOptions(key){
            const sel = document.getElementById('speciesSelect');
            sel.innerHTML = '<option value="random">Random Species</option>' +
                datasets[key].slice(0,300).map((r,i)=>`<option value="${i}">${r.common}</option>`).join('');
        }

        function getExtinctionRange(years) {
            if (years <= 60) {
                return '50-60 YEARS';
            } else if (years <= 70) {
                return '60-70 YEARS';
            } else if (years <= 80) {
                return '70-80 YEARS';
            } else if (years <= 90) {
                return '80-90 YEARS';
            } else if (years <= 100) {
                return '90-100 YEARS';
            } else if (years <= 110) {
                return '100-110 YEARS';
            } else if (years <= 120) {
                return '110-120 YEARS';
            } else if (years <= 130) {
                return '120-130 YEARS';
            } else if (years <= 140) {
                return '130-140 YEARS';
            } else if (years <= 150) {
                return '140-150 YEARS';
            } else if (years <= 160) {
                return '150-160 YEARS';
            } else if (years <= 170) {
                return '160-170 YEARS';
            } else if (years <= 180) {
                return '170-180 YEARS';
            } else if (years <= 190) {
                return '180-190 YEARS';
            } else if (years <= 200) {
                return '190-200 YEARS';
            } else {
                return '200+ YEARS';
            }
        }

        async function getSpeciesFact(speciesName) {
            console.log('Getting fact for species:', speciesName);
            
            const facts = {
                // Wildlife facts - exact matches
                'Lion-tailed Macaque': 'These primates are known for their distinctive mane-like tuft of hair around their face, giving them a lion-like appearance. They are one of the most endangered primates in India.',
                'Bonnet Macaque': 'Named for the cap-like tuft of hair on their heads, these monkeys are highly adaptable and often seen in urban areas across South India.',
                'Nilgiri Langur': 'These langurs are endemic to the Western Ghats and are known for their striking black and silver fur. They play a crucial role in seed dispersal.',
                'Tufted Grey Langur': 'Also known as the Hanuman Langur, they are considered sacred in Hindu mythology and are often found near temples.',
                'Bengal Tiger': 'The national animal of India, these magnificent cats can swim and are known to travel long distances in search of territory.',
                'Indian Elephant': 'These gentle giants have the largest brain of any land animal and are known for their complex social structures and memory.',
                'Leopard': 'These elusive big cats are excellent climbers and can carry prey twice their body weight up trees.',
                'Sloth Bear': 'Despite their name, sloth bears are actually quite fast runners and are the only bears that carry their young on their backs.',
                'Indian Rhinoceros': 'Also called the Greater One-horned Rhinoceros, they have a single horn and are excellent swimmers.',
                'Wild Boar': 'These omnivores have an incredible sense of smell and can run up to 30 mph when threatened.',
                
                // Aquatic facts - exact matches
                'Ganges River Dolphin': 'These blind dolphins use echolocation to navigate and are considered the national aquatic animal of India.',
                'Mugger Crocodile': 'These crocodiles can live up to 50 years and are known for their ability to survive in both fresh and saltwater.',
                'Indian Flapshell Turtle': 'These turtles can retract their heads completely into their shells and are excellent swimmers.',
                'Giant Freshwater Prawn': 'One of the largest freshwater prawns in the world, they can grow up to 30 cm in length.',
                'Indian Major Carp': 'These fish are known for their rapid growth and are important in aquaculture across India.',
                'Hilsa Fish': 'Considered the "king of fish" in Bengal, Hilsa is known for its unique taste and cultural significance.',
                'Mahseer': 'Known as the "tiger of the water," these fish are highly prized by anglers and can grow up to 2 meters in length.',
                'Gharial': 'These crocodilians have the longest snout of any crocodile species and are critically endangered.',
                'Indian Softshell Turtle': 'These turtles can breathe through their skin and are known for their soft, leathery shells.',
                'Gangetic Shark': 'Despite being called a shark, this species is actually a type of catfish and is endemic to the Ganges River system.',
                
                // Additional species with unique facts
                'South-western Langur': 'These langurs are endemic to the Western Ghats and are known for their distinctive black and silver fur. They are excellent seed dispersers.',
                'Common Langur': 'These langurs are highly social animals that live in troops and are known for their loud alarm calls that warn other animals of danger.',
                'Rhesus Macaque': 'These monkeys are highly intelligent and have been used extensively in medical research. They are also excellent swimmers.',
                'Assam Macaque': 'These macaques are found in the northeastern regions of India and are known for their distinctive cheek pouches.',
                'Golden Langur': 'These langurs are critically endangered and are known for their striking golden fur. They are found only in a small region of Assam.',
                'Hoolock Gibbon': 'These are the only apes found in India and are known for their loud, melodious calls that can be heard from miles away.',
                'Indian Pangolin': 'These scaly mammals are the most trafficked animals in the world due to their scales being used in traditional medicine.',
                'Indian Giant Squirrel': 'These squirrels are among the largest in the world and are known for their vibrant, multi-colored fur.',
                'Malabar Giant Squirrel': 'These squirrels are endemic to the Western Ghats and are known for their ability to glide between trees.',
                'Indian Flying Fox': 'These are the largest bats in India and play a crucial role in pollination and seed dispersal.',
                
                // Aquatic species with unique facts
                'Indian Mackerel': 'These fish are known for their distinctive blue-green stripes and are an important commercial fish species.',
                'Pomfret': 'These flatfish are highly prized for their delicate flavor and are often called the "chicken of the sea."',
                'Catla': 'These carp are known for their large size and are one of the most important fish in Indian aquaculture.',
                'Rohu': 'These fish are known for their rapid growth and are widely farmed across India for their nutritional value.',
                'Mrigal': 'These bottom-feeding fish are known for their ability to clean water bodies by feeding on organic matter.',
                'Indian Catfish': 'These fish are known for their whisker-like barbels and are excellent at surviving in low-oxygen conditions.',
                'Snakehead': 'These predatory fish can breathe air and are known for their ability to survive out of water for several days.',
                'Tilapia': 'These fish are known for their rapid reproduction and are widely used in aquaculture worldwide.',
                'Indian Carp': 'These fish are known for their hardiness and are important in maintaining water quality in ponds and lakes.',
                'Freshwater Eel': 'These mysterious fish can travel thousands of kilometers to spawn and are known for their snake-like appearance.'
            };
            
            // Try to find exact match first
            if (facts[speciesName]) {
                console.log('Found exact match for:', speciesName);
                return facts[speciesName];
            }
            
            // Try to find partial match with better logic
            const lowerSpeciesName = speciesName.toLowerCase();
            for (const [key, fact] of Object.entries(facts)) {
                const lowerKey = key.toLowerCase();
                if (lowerSpeciesName.includes(lowerKey) || lowerKey.includes(lowerSpeciesName)) {
                    console.log('Found partial match for:', speciesName, 'matching:', key);
                    return fact;
                }
            }
            
            // Generate unique fact based on species characteristics
            const uniqueFacts = [
                `The ${speciesName} plays a crucial role in maintaining ecological balance through its unique feeding habits and habitat preferences.`,
                `This species of ${speciesName} has evolved remarkable adaptations to survive in its specific environment, making it an important indicator of ecosystem health.`,
                `The ${speciesName} contributes significantly to biodiversity through its interactions with other species and its role in the food web.`,
                `Known for its distinctive characteristics, the ${speciesName} is an essential component of its ecosystem and requires careful conservation efforts.`,
                `The ${speciesName} demonstrates remarkable resilience and adaptability, making it a fascinating subject for ecological studies and conservation research.`
            ];
            
            // Use species name to generate a consistent but unique fact
            const hash = speciesName.split('').reduce((a, b) => {
                a = ((a << 5) - a) + b.charCodeAt(0);
                return a & a;
            }, 0);
            const factIndex = Math.abs(hash) % uniqueFacts.length;
            
            console.log('Using generated fact for:', speciesName);
            return uniqueFacts[factIndex];
        }

        async function fetchGeneratedFact(speciesName){
            if (!FACTS_API_KEY || !FACTS_API_URL) throw new Error('Facts API not configured');
            
            try {
                console.log('Fetching fact for:', speciesName);
                
                // Try with minimal headers first
                const res = await fetch(FACTS_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + FACTS_API_KEY
                    },
                    body: JSON.stringify({
                        model: 'openrouter/auto',
                        messages: [
                            { role: 'user', content: `One interesting fact about ${speciesName}:` }
                        ],
                        max_tokens: 25,
                        temperature: 0.8
                    })
                });
                
                console.log('API response status:', res.status);
                console.log('API response headers:', Object.fromEntries(res.headers.entries()));
                
                if (!res.ok) {
                    const errorText = await res.text();
                    console.error('API error response:', errorText);
                    throw new Error(`HTTP ${res.status}: ${errorText}`);
                }
                
                const data = await res.json();
                console.log('API response data:', data);
                
                if (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    const fact = data.choices[0].message.content.trim();
                    console.log('Generated fact:', fact);
                    
                    // Check for duplicate facts
                    if (LAST_FACT_BY_SPECIES[speciesName] && LAST_FACT_BY_SPECIES[speciesName] === fact) {
                        console.log('Same fact detected, retrying...');
                        return await fetchGeneratedFactRetry(speciesName);
                    }
                    
                    LAST_FACT_BY_SPECIES[speciesName] = fact;
                    return fact;
                }
                throw new Error('No content in response');
                
            } catch (err) {
                console.error('Fact fetch error:', err);
                throw err;
            }
        }

        async function fetchGeneratedFactRetry(speciesName){
            try {
                console.log('Retrying fact fetch for:', speciesName);
                const res = await fetch(FACTS_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + FACTS_API_KEY
                    },
                    body: JSON.stringify({
                        model: 'openrouter/auto',
                        messages: [
                            { role: 'user', content: `Another fact about ${speciesName}:` }
                        ],
                        max_tokens: 25,
                        temperature: 0.9
                    })
                });
                
                if (!res.ok) throw new Error('Retry failed: ' + res.status);
                
                const data = await res.json();
                if (data && data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) {
                    const fact = data.choices[0].message.content.trim();
                    LAST_FACT_BY_SPECIES[speciesName] = fact;
                    return fact;
                }
                throw new Error('No content in retry response');
            } catch (err) {
                console.error('Retry failed:', err);
                throw err;
            }
        }

        // Enhanced Visualization Functions
        let populationProjectionChart = null;
        let threatBreakdownChart = null;
        let habitatHeatmap = null;
        let currentSpeciesData = null;
        let baselineValues = {};

        function renderPopulationProjection(speciesData) {
            const canvas = document.getElementById('populationProjectionChart');
            if (!canvas) return;

            if (populationProjectionChart) {
                populationProjectionChart.destroy();
            }

            const years = [];
            const population = [];
            const upperBound = [];
            const lowerBound = [];
            const criticalThreshold = [];

            const currentPop = parseFloat(speciesData.population) || 1000;
            const growthRate = parseFloat(speciesData.correlation) || 0.02;
            const stochasticity = 0.1; // Default environmental stochasticity
            const totalThreats = calculateTotalThreats(speciesData);
            
            // Calculate critical threshold (50% extinction probability)
            const criticalPop = currentPop * 0.1; // 10% of current population

            for (let year = 0; year <= 100; year += 5) {
                years.push(2024 + year);
                
                // Population projection based on actual correlation and years data
                const declineFactor = Math.pow(1 - Math.min(0.95, growthRate * 0.8), year / Math.max(40, Math.min(200, speciesData.years)));
                const stochasticFactor = 1 + (Math.random() - 0.5) * stochasticity;
                const projectedPop = currentPop * declineFactor * stochasticFactor;
                
                population.push(Math.max(projectedPop, 0));
                upperBound.push(projectedPop * 1.1);
                lowerBound.push(projectedPop * 0.9);
                criticalThreshold.push(criticalPop);
            }

            populationProjectionChart = new Chart(canvas, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: 'Population Projection',
                        data: population,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        borderWidth: 4,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#4CAF50',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2
                    }, {
                        label: 'Uncertainty Band (Upper)',
                        data: upperBound,
                        borderColor: 'rgba(76, 175, 80, 0.4)',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 1,
                        fill: false,
                        pointRadius: 0,
                        borderDash: [2, 2]
                    }, {
                        label: 'Uncertainty Band (Lower)',
                        data: lowerBound,
                        borderColor: 'rgba(76, 175, 80, 0.4)',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 1,
                        fill: '+1',
                        pointRadius: 0,
                        borderDash: [2, 2]
                    }, {
                        label: 'Critical Threshold (50% Extinction Risk)',
                        data: criticalThreshold,
                        borderColor: '#F44336',
                        backgroundColor: 'rgba(244, 67, 54, 0.1)',
                        borderWidth: 3,
                        borderDash: [8, 4],
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 25,
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.datasets.map((dataset, i) => {
                                            const meta = chart.getDatasetMeta(i);
                                            return {
                                                text: dataset.label,
                                                fillStyle: dataset.borderColor,
                                                strokeStyle: dataset.borderColor,
                                                lineWidth: dataset.borderWidth,
                                                pointStyle: dataset.pointRadius > 0 ? 'circle' : 'line',
                                                hidden: false,
                                                datasetIndex: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: function(context) {
                                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                return isDarkMode ? 'rgba(0, 0, 0, 0.9)' : 'rgba(255, 255, 255, 0.95)';
                            },
                            titleColor: function(context) {
                                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                return isDarkMode ? '#ffffff' : '#333333';
                            },
                            bodyColor: function(context) {
                                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                return isDarkMode ? '#ffffff' : '#333333';
                            },
                            borderColor: '#4CAF50',
                            borderWidth: 2,
                            cornerRadius: 8,
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return `Year: ${context[0].label}`;
                                },
                                label: function(context) {
                                    if (context.datasetIndex === 0) {
                                        return `Population: ${Math.round(context.parsed.y).toLocaleString()}`;
                                    } else if (context.datasetIndex === 3) {
                                        return `Critical Threshold: ${Math.round(context.parsed.y).toLocaleString()}`;
                                    }
                                    return context.dataset.label + ': ' + Math.round(context.parsed.y).toLocaleString();
                                },
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 0) {
                                        const pop = context.parsed.y;
                                        const threshold = criticalThreshold[context.dataIndex];
                                        if (pop < threshold) {
                                            return '‚ö†Ô∏è Below critical threshold!';
                                        } else if (pop < threshold * 1.5) {
                                            return '‚ö†Ô∏è Near critical threshold';
                                        }
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Years',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: function(context) {
                                    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                    return isDarkMode ? '#ffffff' : '#666';
                                }
                            },
                            grid: {
                                color: function(context) {
                                    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                    return isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                                },
                                drawBorder: false
                            },
                            ticks: {
                                color: function(context) {
                                    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                    return isDarkMode ? '#ffffff' : '#666';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Population Size',
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                color: function(context) {
                                    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                    return isDarkMode ? '#ffffff' : '#666';
                                }
                            },
                            beginAtZero: true,
                            grid: {
                                color: function(context) {
                                    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                    return isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                                },
                                drawBorder: false
                            },
                            ticks: {
                                color: function(context) {
                                    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                    return isDarkMode ? '#ffffff' : '#666';
                                },
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function renderThreatBreakdown(speciesData) {
            const canvas = document.getElementById('threatBreakdownChart');
            if (!canvas) {
                console.error('threatBreakdownChart canvas not found');
                return;
            }

            if (threatBreakdownChart) {
                threatBreakdownChart.destroy();
            }

            // Use the normalized data structure to get threat scores
            let threats = [];

            if (speciesData.pollution !== undefined) {
                // Aquatic species - use aquatic threat factors
                threats = [
                    {
                        name: 'Water Pollution',
                        value: parseFloat(speciesData.pollution) || 0,
                        color: '#9C27B0'
                    },
                    {
                        name: 'Overfishing',
                        value: parseFloat(speciesData.overfishing) || 0,
                        color: '#FF9800'
                    },
                    {
                        name: 'Climate Change',
                        value: parseFloat(speciesData.climateChange) || 0,
                        color: '#2196F3'
                    },
                    {
                        name: 'Overharvest',
                        value: parseFloat(speciesData.overharvest) || 0,
                        color: '#4CAF50'
                    }
                ];
            } else {
                // Wildlife species - use wildlife threat factors
                threats = [
                    {
                        name: 'Habitat Fragmentation',
                        value: parseFloat(speciesData.fragmentation) || 0,
                        color: '#8D6E63'
                    },
                    {
                        name: 'Poaching',
                        value: parseFloat(speciesData.poaching) || 0,
                        color: '#FF9800'
                    },
                    {
                        name: 'Human Conflict',
                        value: parseFloat(speciesData.conflict) || 0,
                        color: '#F44336'
                    },
                    {
                        name: 'Harvest Rate',
                        value: parseFloat(speciesData.harvest) || 0,
                        color: '#795548'
                    }
                ];
            }

            // Filter out zero values and calculate percentages
            threats = threats.filter(threat => threat.value > 0);
            const total = threats.reduce((sum, threat) => sum + threat.value, 0);
            
            if (total === 0) {
                // Show a message if no threat data is available
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#666';
                ctx.font = '16px Poppins';
                ctx.textAlign = 'center';
                ctx.fillText('No threat data available', canvas.width / 2, canvas.height / 2);
                return;
            }

            threats.forEach(threat => {
                threat.percentage = (threat.value / total * 100).toFixed(1);
            });

            // Sort by value (highest first) - dominant threat will be largest
            threats.sort((a, b) => b.value - a.value);

            console.log('Rendering threat breakdown with data:', threats);

            threatBreakdownChart = new Chart(canvas, {
                type: 'doughnut',
                data: {
                    labels: threats.map(t => `${t.name} (${t.percentage}%)`),
                    datasets: [{
                        data: threats.map(t => t.value),
                        backgroundColor: threats.map(t => t.color),
                        borderWidth: 3,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 4,
                        hoverBorderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                color: function(context) {
                                    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                    return isDarkMode ? '#ffffff' : '#333333';
                                },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const meta = chart.getDatasetMeta(0);
                                            const style = meta.controller.getStyle(i);
                                            return {
                                                text: label,
                                                fillStyle: style.backgroundColor,
                                                strokeStyle: style.borderColor,
                                                lineWidth: style.borderWidth,
                                                pointStyle: 'circle',
                                                hidden: false,
                                                index: i,
                                                fontColor: isDarkMode ? '#ffffff' : '#333333'
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: function(context) {
                                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                return isDarkMode ? 'rgba(0, 0, 0, 0.9)' : 'rgba(255, 255, 255, 0.95)';
                            },
                            titleColor: function(context) {
                                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                return isDarkMode ? '#ffffff' : '#333333';
                            },
                            bodyColor: function(context) {
                                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                return isDarkMode ? '#ffffff' : '#333333';
                            },
                            borderColor: function(context) {
                                const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
                                return isDarkMode ? '#ffffff' : '#333333';
                            },
                            borderWidth: 2,
                            callbacks: {
                                label: function(context) {
                                    const threat = threats[context.dataIndex];
                                    return `${threat.name}: ${threat.value.toFixed(2)} (${threat.percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%',
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 1000
                    }
                }
            });
            
            // Populate threat analysis insights
            populateThreatInsights(threats, speciesData);
        }
        
        function populateThreatInsights(threats, speciesData) {
            // Update threat insights
            const primaryThreatEl = document.getElementById('primaryThreatText');
            const secondaryThreatEl = document.getElementById('secondaryThreatText');
            const threatDiversityEl = document.getElementById('threatDiversityText');
            const threatCountEl = document.getElementById('threatCount');
            const riskScoreEl = document.getElementById('riskScore');
            
            // Update action plan
            const highPriorityEl = document.getElementById('highPriorityAction');
            const mediumPriorityEl = document.getElementById('mediumPriorityAction');
            const lowPriorityEl = document.getElementById('lowPriorityAction');
            
            if (threats.length > 0) {
                // Primary threat (highest value)
                const primaryThreat = threats[0];
                if (primaryThreatEl) {
                    primaryThreatEl.textContent = `${primaryThreat.name} accounts for ${primaryThreat.percentage}% of total threats`;
                }
                
                // Secondary threat
                const secondaryThreat = threats[1];
                if (secondaryThreatEl && secondaryThreat) {
                    secondaryThreatEl.textContent = `${secondaryThreat.name} contributes ${secondaryThreat.percentage}% to extinction risk`;
                } else if (secondaryThreatEl) {
                    secondaryThreatEl.textContent = 'No significant secondary threat identified';
                }
                
                // Threat diversity analysis
                if (threatDiversityEl) {
                    const diversityScore = threats.length;
                    let diversityText = '';
                    if (diversityScore <= 2) {
                        diversityText = 'Low diversity - focused threat profile';
                    } else if (diversityScore <= 3) {
                        diversityText = 'Moderate diversity - multiple threat sources';
                    } else {
                        diversityText = 'High diversity - complex threat landscape';
                    }
                    threatDiversityEl.textContent = diversityText;
                }
                
                // Quick stats
                if (threatCountEl) threatCountEl.textContent = threats.length;
                if (riskScoreEl) {
                    const totalRisk = threats.reduce((sum, t) => sum + t.value, 0);
                    const riskPercentage = Math.min(100, Math.round(totalRisk * 100));
                    riskScoreEl.textContent = riskPercentage + '%';
                }
                
                // Action plan based on primary threat
                const primaryThreatName = primaryThreat.name.toLowerCase();
                if (highPriorityEl) {
                    if (primaryThreatName.includes('habitat') || primaryThreatName.includes('fragmentation')) {
                        highPriorityEl.textContent = 'Establish protected corridors and restore degraded habitats';
                    } else if (primaryThreatName.includes('poaching')) {
                        highPriorityEl.textContent = 'Strengthen anti-poaching patrols and law enforcement';
                    } else if (primaryThreatName.includes('pollution')) {
                        highPriorityEl.textContent = 'Implement water quality monitoring and pollution controls';
                    } else if (primaryThreatName.includes('climate')) {
                        highPriorityEl.textContent = 'Develop climate adaptation strategies and refugia';
                    } else if (primaryThreatName.includes('conflict')) {
                        highPriorityEl.textContent = 'Implement human-wildlife conflict mitigation measures';
                    } else {
                        highPriorityEl.textContent = 'Address primary threat through targeted conservation';
                    }
                }
                
                if (mediumPriorityEl) {
                    if (secondaryThreat) {
                        const secondaryName = secondaryThreat.name.toLowerCase();
                        if (secondaryName.includes('habitat')) {
                            mediumPriorityEl.textContent = 'Monitor habitat quality and connectivity';
                        } else if (secondaryName.includes('poaching')) {
                            mediumPriorityEl.textContent = 'Community education and alternative livelihoods';
                        } else if (secondaryName.includes('pollution')) {
                            mediumPriorityEl.textContent = 'Reduce agricultural and industrial runoff';
                        } else {
                            mediumPriorityEl.textContent = 'Monitor and mitigate secondary threats';
                        }
                    } else {
                        mediumPriorityEl.textContent = 'Maintain population monitoring programs';
                    }
                }
                
                if (lowPriorityEl) {
                    lowPriorityEl.textContent = 'Continue research and long-term monitoring';
                }
            } else {
                // No threat data available
                if (primaryThreatEl) primaryThreatEl.textContent = 'No threat data available';
                if (secondaryThreatEl) secondaryThreatEl.textContent = 'Assessment needed';
                if (threatDiversityEl) threatDiversityEl.textContent = 'Threat profile unknown';
                if (threatCountEl) threatCountEl.textContent = '?';
                if (riskScoreEl) riskScoreEl.textContent = '?';
                if (highPriorityEl) highPriorityEl.textContent = 'Conduct comprehensive threat assessment';
                if (mediumPriorityEl) mediumPriorityEl.textContent = 'Establish baseline monitoring';
                if (lowPriorityEl) lowPriorityEl.textContent = 'Develop conservation strategy';
            }
            
            // Populate Conservation Impact Tracker
            populateConservationTracker(threats, speciesData);
        }
        
        function populateConservationTracker(threats, speciesData) {
            // Update species risk comparison (simulate ecosystem data)
            const criticalEl = document.getElementById('criticalSpeciesCount');
            const highRiskEl = document.getElementById('highRiskCount');
            const stableEl = document.getElementById('stableSpeciesCount');
            
            // Simulate ecosystem species counts based on current species status
            const status = (speciesData.status || '').toLowerCase();
            if (criticalEl && highRiskEl && stableEl) {
                if (status.includes('critically endangered')) {
                    criticalEl.textContent = Math.floor(Math.random() * 5) + 3; // 3-7
                    highRiskEl.textContent = Math.floor(Math.random() * 8) + 5; // 5-12
                    stableEl.textContent = Math.floor(Math.random() * 15) + 10; // 10-24
                } else if (status.includes('endangered')) {
                    criticalEl.textContent = Math.floor(Math.random() * 3) + 1; // 1-3
                    highRiskEl.textContent = Math.floor(Math.random() * 6) + 4; // 4-9
                    stableEl.textContent = Math.floor(Math.random() * 20) + 15; // 15-34
                } else {
                    criticalEl.textContent = Math.floor(Math.random() * 2) + 1; // 1-2
                    highRiskEl.textContent = Math.floor(Math.random() * 4) + 2; // 2-5
                    stableEl.textContent = Math.floor(Math.random() * 25) + 20; // 20-44
                }
            }
            
            // Update conservation success indicators
            const populationTrendEl = document.getElementById('populationTrend');
            const habitatQualityEl = document.getElementById('habitatQuality');
            
            if (populationTrendEl) {
                const years = speciesData.years || 50;
                if (years < 30) {
                    populationTrendEl.innerHTML = 'üìâ <span style="color: #F44336;">Declining</span>';
                } else if (years < 70) {
                    populationTrendEl.innerHTML = 'üìä <span style="color: #FF9800;">Stable</span>';
                } else {
                    populationTrendEl.innerHTML = 'üìà <span style="color: #4CAF50;">Improving</span>';
                }
            }
            
            if (habitatQualityEl) {
                // Base habitat quality on threat levels
                const totalThreatValue = threats.reduce((sum, t) => sum + t.value, 0);
                if (totalThreatValue > 2.0) {
                    habitatQualityEl.innerHTML = 'üî¥ <span style="color: #F44336;">Poor</span>';
                } else if (totalThreatValue > 1.0) {
                    habitatQualityEl.innerHTML = 'üü° <span style="color: #FF9800;">Fair</span>';
                } else {
                    habitatQualityEl.innerHTML = 'üü¢ <span style="color: #4CAF50;">Good</span>';
                }
            }
            
            // Update biodiversity index
            const biodiversityIndexEl = document.getElementById('biodiversityIndex');
            const biodiversityBarEl = document.getElementById('biodiversityBar');
            
            if (biodiversityIndexEl && biodiversityBarEl) {
                // Calculate biodiversity based on species status and threats
                let biodiversityScore = 85; // Base score
                
                if (status.includes('critically endangered')) biodiversityScore -= 30;
                else if (status.includes('endangered')) biodiversityScore -= 20;
                else if (status.includes('vulnerable')) biodiversityScore -= 10;
                
                // Adjust for threat levels
                const avgThreat = threats.length > 0 ? threats.reduce((sum, t) => sum + t.value, 0) / threats.length : 0;
                biodiversityScore -= Math.round(avgThreat * 20);
                
                biodiversityScore = Math.max(25, Math.min(95, biodiversityScore));
                
                biodiversityIndexEl.textContent = biodiversityScore + '%';
                biodiversityBarEl.style.width = biodiversityScore + '%';
                
                // Update bar color based on score
                if (biodiversityScore < 50) {
                    biodiversityBarEl.style.background = 'linear-gradient(90deg, #F44336, #FF5722)';
                } else if (biodiversityScore < 75) {
                    biodiversityBarEl.style.background = 'linear-gradient(90deg, #FF9800, #FFC107)';
                } else {
                    biodiversityBarEl.style.background = 'linear-gradient(90deg, #4CAF50, #8BC34A)';
                }
            }
            
            // Update conservation timeline
            const immediateEl = document.getElementById('immediateAction');
            const shortTermEl = document.getElementById('shortTermAction');
            const longTermEl = document.getElementById('longTermAction');
            
            if (immediateEl && shortTermEl && longTermEl) {
                const years = speciesData.years || 50;
                
                if (years < 20) {
                    immediateEl.textContent = 'Emergency population rescue';
                    shortTermEl.textContent = 'Captive breeding program';
                    longTermEl.textContent = 'Habitat reconstruction';
                } else if (years < 50) {
                    immediateEl.textContent = 'Threat mitigation measures';
                    shortTermEl.textContent = 'Habitat protection zones';
                    longTermEl.textContent = 'Population recovery plan';
                } else {
                    immediateEl.textContent = 'Monitoring enhancement';
                    shortTermEl.textContent = 'Preventive conservation';
                    longTermEl.textContent = 'Ecosystem management';
                }
            }
            
            // Update related species alert
            const relatedSpeciesEl = document.getElementById('relatedSpeciesInfo');
            if (relatedSpeciesEl) {
                const ecosystem = speciesData.pollution !== undefined ? 'aquatic' : 'terrestrial';
                const commonName = speciesData.common || 'this species';
                
                if (ecosystem === 'aquatic') {
                    relatedSpeciesEl.textContent = `Other aquatic species in ${commonName}'s habitat may face similar water quality and overfishing pressures. Consider watershed-level conservation approaches.`;
                } else {
                    relatedSpeciesEl.textContent = `Other wildlife in ${commonName}'s range may experience similar habitat fragmentation and human pressures. Implement landscape-scale conservation corridors.`;
                }
            }
        }

        function renderHabitatHeatmap(speciesData) {
            const canvas = document.getElementById('habitatHeatmap');
            if (!canvas) {
                console.error('habitatHeatmap canvas not found');
                return;
            }

            if (habitatHeatmap) {
                habitatHeatmap.destroy();
            }

            const ctx = canvas.getContext('2d');
            const width = canvas.width = canvas.offsetWidth;
            const height = canvas.height = canvas.offsetHeight;

            // Create heatmap data with larger grid for better visibility
            const gridSize = 15;
            const cellWidth = width / gridSize;
            const cellHeight = height / gridSize;

            ctx.clearRect(0, 0, width, height);

            // Add gradient background
            const gradient = ctx.createLinearGradient(0, 0, width, 0);
            gradient.addColorStop(0, 'rgba(244, 67, 54, 0.1)');
            gradient.addColorStop(0.5, 'rgba(255, 193, 7, 0.1)');
            gradient.addColorStop(1, 'rgba(76, 175, 80, 0.1)');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, width, height);

            for (let x = 0; x < gridSize; x++) {
                for (let y = 0; y < gridSize; y++) {
                    const habitatQuality = x / (gridSize - 1);
                    const threatLevel = 1 - (y / (gridSize - 1));
                    
                    // Calculate extinction years based on habitat and threat
                    const extinctionYears = calculateExtinctionYears(habitatQuality, threatLevel, speciesData);
                    
                    // Enhanced color scheme with gradients
                    let color;
                    let borderColor = '#ffffff';
                    if (extinctionYears > 100) {
                        color = '#4CAF50'; // Green
                        borderColor = '#2E7D32';
                    } else if (extinctionYears > 50) {
                        color = '#FFC107'; // Yellow
                        borderColor = '#F57F17';
                    } else if (extinctionYears > 20) {
                        color = '#FF9800'; // Orange
                        borderColor = '#F57C00';
                    } else {
                        color = '#F44336'; // Red
                        borderColor = '#D32F2F';
                    }

                    // Draw cell with border
                    ctx.fillStyle = color;
                    ctx.fillRect(x * cellWidth + 1, y * cellHeight + 1, cellWidth - 2, cellHeight - 2);
                    
                    // Add border
                    ctx.strokeStyle = borderColor;
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x * cellWidth + 1, y * cellHeight + 1, cellWidth - 2, cellHeight - 2);

                    // Add text for years with better visibility
                    if (cellWidth > 15 && cellHeight > 15) {
                        ctx.fillStyle = extinctionYears > 50 ? '#000000' : '#ffffff';
                        ctx.font = 'bold 12px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(Math.round(extinctionYears), 
                            x * cellWidth + cellWidth/2, 
                            y * cellHeight + cellHeight/2);
                    }
                }
            }

            // Add enhanced axis labels with better styling for dark mode
            const isDarkMode = document.documentElement.getAttribute('data-theme') === 'dark';
            ctx.fillStyle = isDarkMode ? '#ffffff' : '#333';
            ctx.font = 'bold 12px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Habitat Quality ‚Üí', width/2, height - 8);
            
            ctx.save();
            ctx.translate(15, height/2);
            ctx.rotate(-Math.PI/2);
            ctx.fillText('Threat Level ‚Üí', 0, 0);
            ctx.restore();

            // Add comprehensive color legend with explanations
            const legendY = 10;
            const legendItems = [
                { color: '#4CAF50', label: '>100y', desc: 'Long-term survival' },
                { color: '#FFC107', label: '50-100y', desc: 'Moderate survival' },
                { color: '#FF9800', label: '20-50y', desc: 'Short-term survival' },
                { color: '#F44336', label: '<20y', desc: 'Near extinction' }
            ];

            // Create legend background for better visibility
            ctx.fillStyle = isDarkMode ? 'rgba(0, 0, 0, 0.8)' : 'rgba(255, 255, 255, 0.9)';
            ctx.fillRect(width - 200, 5, 190, 60);
            ctx.strokeStyle = isDarkMode ? '#ffffff' : '#333';
            ctx.lineWidth = 1;
            ctx.strokeRect(width - 200, 5, 190, 60);

            legendItems.forEach((item, index) => {
                const x = width - 190 + (index * 45);
                ctx.fillStyle = item.color;
                ctx.fillRect(x, legendY, 15, 10);
                ctx.fillStyle = isDarkMode ? '#ffffff' : '#333';
                ctx.font = 'bold 10px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(item.label, x + 18, legendY + 7);
                ctx.font = '8px Arial';
                ctx.fillText(item.desc, x + 18, legendY + 18);
            });

            // Add main explanation
            ctx.fillStyle = isDarkMode ? '#ffffff' : '#333';
            ctx.font = 'bold 11px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Colors show predicted Years to Extinction', width/2, legendY + 35);
        }

        function calculateTotalThreats(speciesData) {
            const isWildlife = document.getElementById('categorySelect').value === 'Wildlife';
            
            if (isWildlife) {
                return (parseFloat(speciesData.fragmentation) || 0) +
                       (parseFloat(speciesData.poaching) || 0) +
                       (parseFloat(speciesData.conflict) || 0);
            } else {
                return (parseFloat(speciesData.pollution) || 0) +
                       (parseFloat(speciesData.overfishing) || 0) +
                       (parseFloat(speciesData.climateChange) || 0);
            }
        }

        function calculateExtinctionYears(habitatQuality, threatLevel, speciesData) {
            const currentPop = parseFloat(speciesData.population) || 1000;
            const growthRate = parseFloat(speciesData.correlation) || 0.02;
            
            // Realistic extinction calculation using biological principles
            // Use logarithmic scaling for population size to avoid unrealistic values
            const popFactor = Math.log10(Math.max(currentPop, 100)) / 4; // Scale population impact
            const habitatFactor = Math.max(0.1, habitatQuality);
            const threatFactor = Math.max(0.1, threatLevel);
            const growthFactor = Math.max(0.01, growthRate);
            
            // Base extinction risk calculation (years)
            let baseYears;
            const status = speciesData.status || '';
            
            // Set realistic baseline based on conservation status
            if (status.toLowerCase().includes('critically endangered')) {
                baseYears = 15;
            } else if (status.toLowerCase().includes('endangered')) {
                baseYears = 35;
            } else if (status.toLowerCase().includes('vulnerable')) {
                baseYears = 65;
            } else if (status.toLowerCase().includes('near threatened')) {
                baseYears = 95;
            } else {
                baseYears = 120;
            }
            
            // Apply modifiers based on habitat quality and threats
            const habitatModifier = (habitatFactor - 0.5) * 40; // ¬±20 years based on habitat
            const threatModifier = (threatFactor - 0.5) * -30; // ¬±15 years based on threats
            const popModifier = (popFactor - 0.5) * 20; // ¬±10 years based on population
            const growthModifier = (growthFactor - 0.05) * 200; // Growth rate impact
            
            const finalYears = baseYears + habitatModifier + threatModifier + popModifier + growthModifier;
            
            return Math.max(Math.round(finalYears), 5); // Minimum 5 years
        }

        function initializeSimulator() {
            const sliders = ['fragmentation', 'poaching', 'climate', 'habitat', 'growth'];
            
            sliders.forEach(sliderName => {
                const slider = document.getElementById(sliderName + 'Slider');
                const valueDisplay = document.getElementById(sliderName + 'Value');
                
                if (slider && valueDisplay) {
                    slider.addEventListener('input', function() {
                        valueDisplay.textContent = parseFloat(this.value).toFixed(2);
                        updateSimulation();
                    });
                }
            });
        }

        function updateSimulation() {
            if (!currentSpeciesData) return;

            const fragmentation = parseFloat(document.getElementById('fragmentationSlider').value);
            const poaching = parseFloat(document.getElementById('poachingSlider').value);
            const climate = parseFloat(document.getElementById('climateSlider').value);
            const habitat = parseFloat(document.getElementById('habitatSlider').value);
            const growth = parseFloat(document.getElementById('growthSlider').value);

            // Calculate new extinction years using improved formula
            const totalThreats = (fragmentation + poaching + climate) / 3;
            
            // Create modified species data for simulation
            const modifiedSpeciesData = {
                ...currentSpeciesData,
                correlation: growth
            };
            
            const extinctionYears = calculateExtinctionYears(habitat, totalThreats, modifiedSpeciesData);

            // Update display
            document.getElementById('extinctionYears').textContent = extinctionYears + ' years';
            
            // Update risk meter - calculate risk percentage based on extinction years
            let riskPercentage;
            if (extinctionYears <= 20) {
                riskPercentage = 90; // Very high risk
            } else if (extinctionYears <= 50) {
                riskPercentage = 70; // High risk
            } else if (extinctionYears <= 100) {
                riskPercentage = 40; // Moderate risk
            } else {
                riskPercentage = 20; // Low risk
            }
            riskPercentage = Math.min(100, Math.max(0, riskPercentage));
            const riskIndicator = document.getElementById('riskIndicator');
            riskIndicator.style.left = riskPercentage + '%';
            
            document.getElementById('extinctionProbability').textContent = Math.round(riskPercentage) + '%';

            // Update impact summary
            const baselineYears = calculateBaselineExtinction();
            const improvement = extinctionYears - baselineYears;
            const improvementPercent = baselineYears > 0 ? (improvement / baselineYears * 100).toFixed(1) : 0;

            let impactText = `Intervention Impact: `;
            if (improvement > 0) {
                impactText += `üî∫ +${improvement.toFixed(1)} years (+${improvementPercent}% improvement)`;
            } else if (improvement < 0) {
                impactText += `üîª ${improvement.toFixed(1)} years (${improvementPercent}% decline)`;
            } else {
                impactText += `‚û°Ô∏è No significant change`;
            }

            document.getElementById('impactText').innerHTML = impactText;

            // Update charts
            renderPopulationProjection(currentSpeciesData);
            renderThreatBreakdown(currentSpeciesData);
        }

        function calculateBaselineExtinction() {
            if (!currentSpeciesData) return 50;
            
            // Use the improved calculation with default values (0.5 for all sliders)
            const baselineSpeciesData = {
                ...currentSpeciesData,
                correlation: 0.5 // Default growth rate from slider
            };
            
            return calculateExtinctionYears(0.5, 0.5, baselineSpeciesData); // Default habitat=0.5, threats=0.5
        }

        function renderDetails(item){
            const yearsEl = document.getElementById('yearsValue');
            const threatEl = document.getElementById('dominantThreat');
            const suggestionEl = document.getElementById('suggestion');
            const sciEl = document.getElementById('sciName');
            const commonEl = document.getElementById('speciesCommon');
            const statusEl = document.getElementById('status');
            const contribBarEl = document.getElementById('contribBar');
            const contribNumEl = document.getElementById('contribNum');
            const dominantFactorEl = document.getElementById('dominantFactor');
            const factEl = document.getElementById('speciesFact');
            
            if (yearsEl) yearsEl.textContent = getExtinctionRange(item.years);
            
            // Use the same dominant threat from CSV for both sections
            let csvDominantThreat = item.dominantThreat || item.threat || '-';
            
            // Convert "Fragmentation" to "Habitat loss and fragmentation" for better clarity
            if (csvDominantThreat.toLowerCase().includes('fragmentation') && !csvDominantThreat.toLowerCase().includes('habitat')) {
                csvDominantThreat = 'Habitat loss and fragmentation';
            }
            
            if (threatEl) threatEl.textContent = 'Dominant Threat: ' + csvDominantThreat;
            if (dominantFactorEl) dominantFactorEl.textContent = csvDominantThreat;
            
            if (suggestionEl) suggestionEl.textContent = item.suggestion || '-';
            if (sciEl) sciEl.textContent = item.scientific || '-';
            if (commonEl) commonEl.textContent = item.common || '‚Äî';
            if (statusEl) statusEl.textContent = item.status || '‚Äî';
            
            // Populate new fields with useful information
            const populationEl = document.getElementById('populationSize');
            const extinctionRiskEl = document.getElementById('extinctionRisk');
            const conservationInfoEl = document.getElementById('conservationInfo');
            
            if (populationEl) {
                const population = item.population || 0;
                if (population > 0) {
                    populationEl.textContent = population.toLocaleString() + ' individuals';
                } else {
                    populationEl.textContent = 'Data unavailable';
                }
            }
            
            if (extinctionRiskEl) {
                const years = item.years || 0;
                let riskLevel = '';
                let riskColor = '';
                
                if (years < 20) {
                    riskLevel = 'Critical (< 20 years)';
                    riskColor = '#F44336';
                } else if (years < 50) {
                    riskLevel = 'High (20-50 years)';
                    riskColor = '#FF9800';
                } else if (years < 100) {
                    riskLevel = 'Moderate (50-100 years)';
                    riskColor = '#FFC107';
                } else {
                    riskLevel = 'Low (> 100 years)';
                    riskColor = '#4CAF50';
                }
                
                extinctionRiskEl.innerHTML = `<span style="color: ${riskColor};">${riskLevel}</span>`;
            }
            
            if (conservationInfoEl) {
                const status = item.status || '';
                let priorityInfo = '';
                
                if (status.toLowerCase().includes('critically endangered')) {
                    priorityInfo = 'Immediate action required. Species faces extremely high risk of extinction in the wild.';
                } else if (status.toLowerCase().includes('endangered')) {
                    priorityInfo = 'Urgent conservation measures needed. High risk of extinction in the wild.';
                } else if (status.toLowerCase().includes('vulnerable')) {
                    priorityInfo = 'Conservation attention required. Moderate risk of extinction in the wild.';
                } else if (status.toLowerCase().includes('near threatened')) {
                    priorityInfo = 'Monitoring recommended. May become threatened in the near future.';
                } else if (status.toLowerCase().includes('least concern')) {
                    priorityInfo = 'Stable population. Continue monitoring and habitat protection.';
                } else {
                    priorityInfo = 'Conservation status assessment needed for proper protection planning.';
                }
                
                conservationInfoEl.textContent = priorityInfo;
            }
            
            // Calculate dominant factor percentage based on threat scores
            let threatScores, factorNames;
            
            if (item.pollution !== undefined) {
                // Aquatic species - use actual CSV threat factors
                threatScores = {
                    pollution: item.pollution || 0,
                    overfishing: item.overfishing || 0,
                    climateChange: item.climateChange || 0,
                    overharvest: item.overharvest || 0,
                    envStochasticity: item.envStochasticity || 0,
                    habitatQuality: item.habitatQuality || 0
                };
                factorNames = {
                    pollution: 'Pollution',
                    overfishing: 'Overfishing',
                    climateChange: 'Climate Change',
                    overharvest: 'Overharvest',
                    envStochasticity: 'Environmental Stochasticity',
                    habitatQuality: 'Habitat Quality'
                };
            } else {
                // Wildlife species - use existing structure
                threatScores = {
                    fragmentation: item.fragmentation || 0,
                    poaching: item.poaching || 0,
                    conflict: item.conflict || 0,
                    harvest: item.harvest || 0
                };
                factorNames = {
                    fragmentation: 'Fragmentation',
                    poaching: 'Poaching',
                    conflict: 'Conflict',
                    harvest: 'Harvest Rate'
                };
            }
            
            const maxThreat = Math.max(...Object.values(threatScores));
            const totalThreat = Object.values(threatScores).reduce((a, b) => a + b, 0);
            const dominantFactor = Object.keys(threatScores).find(key => threatScores[key] === maxThreat);
            const pct = totalThreat > 0 ? Math.max(5, Math.min(100, Math.round((maxThreat / totalThreat) * 100))) : 50;
            
            if (contribBarEl) contribBarEl.style.width = pct + '%';
            if (contribNumEl) contribNumEl.textContent = pct.toFixed(1) + '%';
            
            // Store the CSV dominant threat for consistency
            item.dominantFactorName = csvDominantThreat;
            
            // Show animated loading state immediately
            if (factEl) {
                factEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div class="fact-spinner"></div>
                        <span>Generating fact...</span>
                    </div>
                `;
            }
            
            // Add timeout wrapper for faster failure detection
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('Request timeout')), 6000)
            );
            
            // Fetch fact asynchronously without blocking UI
            Promise.race([
                fetchGeneratedFact(item.common || item.scientific || 'species'),
                timeoutPromise
            ])
            .then(remoteFact => {
                console.log('Successfully fetched fact:', remoteFact);
                if (factEl) factEl.textContent = remoteFact;
            })
            .catch(e => {
                console.error('Fact fetch failed:', e);
                // Show fallback fact instead of error message
                const fallbackFacts = [
                    `The ${item.common} is a fascinating species with unique ecological characteristics.`,
                    `This species plays an important role in its ecosystem and requires conservation attention.`,
                    `The ${item.common} has adapted to survive in challenging environmental conditions.`,
                    `Conservation efforts are crucial for the long-term survival of this species.`
                ];
                const randomFact = fallbackFacts[Math.floor(Math.random() * fallbackFacts.length)];
                if (factEl) factEl.textContent = randomFact;
            });
            
            setSpeciesImage(item);
            
            // Store current species data for simulator
            currentSpeciesData = item;
            
            // Render enhanced visualizations
            renderPopulationProjection(item);
            renderThreatBreakdown(item);
            renderHabitatHeatmap(item);
            
            // Initialize simulator with current data
            initializeSimulator();
            updateSimulation();
        }

        function buildSeries(yearsMax, correlation, currentPop){
            const startYear = 1970, endYear = 2040;
            const labels = [];
            const values = [];
            const total = endYear - startYear;
            for (let i=0;i<=total;i++){
                const y = startYear + i;
                const t = i/total;
                const decline = Math.pow(1 - Math.min(0.95, correlation*0.8), t * (80/Math.max(40, Math.min(200, yearsMax))));
                const value = Math.max(50, Math.round(currentPop*decline));
                labels.push(y);
                values.push(value);
            }
            _lastSeries = { labels, values };
            return _lastSeries;
        }

        function renderChart(labels, values){
            const canvas = document.getElementById('trendChart');
            if (!canvas) {
                console.error('trendChart canvas not found');
                return;
            }
            console.log('Rendering line chart with', labels.length, 'data points');
            const ctx = canvas.getContext('2d');
            const dark = document.documentElement.getAttribute('data-theme')==='dark';
            const grid = dark ? 'rgba(185,212,199,0.12)' : 'rgba(0,0,0,0.06)';
            const text = dark ? '#b9d4c7' : '#5a6c7d';
            const border = dark ? '#6ec99d' : '#2d8659';
            const gradient = ctx.createLinearGradient(0,0,0,280);
            gradient.addColorStop(0, dark ? 'rgba(110,201,157,0.35)' : 'rgba(82,192,147,0.35)');
            gradient.addColorStop(1, dark ? 'rgba(27,94,66,0.05)' : 'rgba(82,192,147,0.05)');
            
            if (window._trendChart) window._trendChart.destroy();
            
            try {
                window._trendChart = new Chart(ctx, {
                    type:'line',
                    data:{ 
                        labels, 
                        datasets:[{ 
                            label:'Population Count', 
                            data: values, 
                            borderColor: border, 
                            borderWidth:3, 
                            pointRadius:2, 
                            pointHoverRadius:5, 
                            pointHitRadius:10, 
                            backgroundColor: gradient, 
                            tension:0.35, 
                            fill:true 
                        }]
                    },
                    options:{
                        responsive:true, 
                        maintainAspectRatio:false,
                        interaction:{ mode:'index', intersect:false },
                        scales:{ 
                            x:{ 
                                grid:{ color:grid }, 
                                ticks:{ color:text }, 
                                title:{ display:true, text:'Year', color:text, font:{ weight:'600' } } 
                            }, 
                            y:{ 
                                min:0, 
                                grid:{ color:grid, borderDash:[4,4] }, 
                                ticks:{ color:text, callback:v=>v.toLocaleString() }, 
                                title:{ display:true, text:'Population Count', color:text, font:{ weight:'600' } } 
                            } 
                        },
                        plugins:{ 
                            legend:{ labels:{ color:text } }, 
                            tooltip:{ 
                                backgroundColor: dark?'rgba(20,40,32,0.9)':'rgba(255,255,255,0.95)', 
                                titleColor: dark?'#e8f5e9':'#1f2b2a', 
                                bodyColor: dark?'#b9d4c7':'#2c3e50', 
                                borderColor: grid, 
                                borderWidth:1, 
                                callbacks:{ label:(ctx)=>` ${ctx.parsed.y.toLocaleString()} individuals` } 
                            }, 
                            zoom:{ 
                                pan:{ enabled:true, mode:'xy' }, 
                                zoom:{ wheel:{ enabled:true }, pinch:{ enabled:true }, mode:'xy' } 
                            } 
                        }
                    }
                });
                console.log('Line chart rendered successfully');
            } catch (error) {
                console.error('Error rendering line chart:', error);
            }
        }

        function renderPieChart(dataset, selectedSpecies = null){
            const canvas = document.getElementById('pieChart');
            if (!canvas) {
                console.error('pieChart canvas not found');
                return;
            }
            console.log('Rendering pie chart with', dataset.length, 'species');
            const ctx = canvas.getContext('2d');
            const dark = document.documentElement.getAttribute('data-theme')==='dark';
            const text = dark ? '#b9d4c7' : '#5a6c7d';
 
            // If a specific species is selected, show its threat factors
            if (selectedSpecies && (selectedSpecies.fragmentation !== undefined || selectedSpecies.pollution !== undefined)) {
                // Wildlife selected species (fragmentation/poaching/conflict/harvest)
                const threatFactors = {
                    ...(selectedSpecies.fragmentation !== undefined ? {
                        'Fragmentation': selectedSpecies.fragmentation || 0,
                        'Poaching': selectedSpecies.poaching || 0,
                        'Conflict': selectedSpecies.conflict || 0,
                        'Harvest Rate': selectedSpecies.harvest || 0
                    } : {}),
                    // Aquatic selected species (actual CSV factors)
                    ...(selectedSpecies.pollution !== undefined ? {
                        'Pollution': selectedSpecies.pollution || 0,
                        'Overfishing': selectedSpecies.overfishing || 0,
                        'Climate Change': selectedSpecies.climateChange || 0,
                        'Overharvest': selectedSpecies.overharvest || 0,
                        'Environmental Stochasticity': selectedSpecies.envStochasticity || 0,
                        'Habitat Quality': selectedSpecies.habitatQuality || 0
                    } : {})
                };
                 
                const labels = Object.keys(threatFactors);
                const data = Object.values(threatFactors);
                const total = data.reduce((a,b) => a + b, 0);
                const colors = ['#e23d3d', '#ff6b35', '#f7931e', '#8bc34a'];
 
                if (window._pieChart) window._pieChart.destroy();
 
                try {
                    window._pieChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: labels.map((label, index) => {
                                const value = data[index];
                                const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
                                return `${label}: ${value.toFixed(3)} (${percentage}%)`;
                            }),
                            datasets: [{
                                data: data,
                                backgroundColor: colors.slice(0, labels.length),
                                borderWidth: 2,
                                borderColor: dark ? '#0f2a1d' : '#ffffff'
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom',
                                    labels: { 
                                        color: text, 
                                        padding: 10,
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: dark?'rgba(20,40,32,0.9)':'rgba(255,255,255,0.95)',
                                    titleColor: dark?'#e8f5e9':'#1f2b2a',
                                    bodyColor: dark?'#b9d4c7':'#2c3e50',
                                    callbacks: {
                                        label: (ctx) => {
                                            const percentage = total > 0 ? ((ctx.parsed / total) * 100).toFixed(1) : '0.0';
                                            return `${ctx.label}: ${ctx.parsed.toFixed(3)} (${percentage}%)`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    console.log('Pie chart rendered successfully with selected species threat factors');
                    return;
                } catch (error) {
                    console.error('Error rendering pie chart:', error);
                }
            }
            
            // Calculate threat factor averages for endangered species
            const endangeredSpecies = dataset.filter(item => 
                item.status && item.status.toLowerCase().includes('endangered')
            );
            
            if (endangeredSpecies.length === 0) {
                console.log('No endangered species found, showing conservation status instead');
                // Fallback to conservation status if no endangered species
                const statusCounts = {};
                dataset.forEach(item => {
                    let status = item.status || 'Unknown';
                    if (status.toLowerCase().includes('critically endangered')) status = 'Critically Endangered';
                    else if (status.toLowerCase().includes('endangered')) status = 'Endangered';
                    else if (status.toLowerCase().includes('vulnerable')) status = 'Vulnerable';
                    else if (status.toLowerCase().includes('near threatened')) status = 'Near Threatened';
                    else if (status.toLowerCase().includes('least concern')) status = 'Least Concern';
                    else if (status.toLowerCase().includes('data deficient')) status = 'Data Deficient';
                    statusCounts[status] = (statusCounts[status] || 0) + 1;
                });
                
                const labels = Object.keys(statusCounts);
                const data = Object.values(statusCounts);
                const total = data.reduce((a,b) => a + b, 0);
                const colors = ['#e23d3d', '#ff6b35', '#f7931e', '#8bc34a', '#4caf50', '#2196f3', '#9c27b0'];
                
                if (window._pieChart) window._pieChart.destroy();
                
                window._pieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels.map(label => `${label} (${statusCounts[label]})`),
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: dark ? '#0f2a1d' : '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { 
                                    color: text, 
                                    padding: 10,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: dark?'rgba(20,40,32,0.9)':'rgba(255,255,255,0.95)',
                                titleColor: dark?'#e8f5e9':'#1f2b2a',
                                bodyColor: dark?'#b9d4c7':'#2c3e50',
                                callbacks: {
                                    label: (ctx) => {
                                        const percentage = ((ctx.parsed / total) * 100).toFixed(1);
                                        return `${ctx.label}: ${ctx.parsed} species (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                return;
            }
            
            // Calculate average threat scores for endangered species
            const threatFactors = {
                'Fragmentation': endangeredSpecies.reduce((sum, item) => sum + (parseFloat(item.fragmentation) || 0), 0) / endangeredSpecies.length,
                'Poaching': endangeredSpecies.reduce((sum, item) => sum + (parseFloat(item.poaching) || 0), 0) / endangeredSpecies.length,
                'Conflict': endangeredSpecies.reduce((sum, item) => sum + (parseFloat(item.conflict) || 0), 0) / endangeredSpecies.length,
                'Harvest Rate': endangeredSpecies.reduce((sum, item) => sum + (parseFloat(item.harvest) || 0), 0) / endangeredSpecies.length
            };
            
            const labels = Object.keys(threatFactors);
            const data = Object.values(threatFactors);
            const total = data.reduce((a,b) => a + b, 0);
            const colors = ['#e23d3d', '#ff6b35', '#f7931e', '#8bc34a'];
            
            if (window._pieChart) window._pieChart.destroy();
            
            try {
                window._pieChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels.map((label, index) => {
                            const value = data[index];
                            const percentage = ((value / total) * 100).toFixed(1);
                            return `${label}: ${value.toFixed(3)} (${percentage}%)`;
                        }),
                        datasets: [{
                            data: data,
                            backgroundColor: colors.slice(0, labels.length),
                            borderWidth: 2,
                            borderColor: dark ? '#0f2a1d' : '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { 
                                    color: text, 
                                    padding: 10,
                                    usePointStyle: true,
                                    pointStyle: 'circle'
                                }
                            },
                            tooltip: {
                                backgroundColor: dark?'rgba(20,40,32,0.9)':'rgba(255,255,255,0.95)',
                                titleColor: dark?'#e8f5e9':'#1f2b2a',
                                bodyColor: dark?'#b9d4c7':'#2c3e50',
                                callbacks: {
                                    label: (ctx) => {
                                        const percentage = ((ctx.parsed / total) * 100).toFixed(1);
                                        return `${ctx.label}: ${ctx.parsed.toFixed(3)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('Pie chart rendered successfully with threat factors');
            } catch (error) {
                console.error('Error rendering pie chart:', error);
            }
        }

        async function ensureLoaded(key){ if (!datasets[key] || datasets[key].length===0) await loadCSV(key); }

        function populateStates(){
            const el = document.getElementById('stateSelect');
            el.innerHTML = STATES.map(s=>`<option value="${s}">${s}</option>`).join('');
            el.value = 'Karnataka';
        }

        async function onSelectionChange(){
            const category = document.getElementById('categorySelect').value; // wildlife or aquatic
            const analyzeBtn = document.getElementById('analyzeBtn');
            // Show same data for all states: wildlife ‚Üí pva_dynamic dataset, aquatic ‚Üí aquatic dataset
            if (category === 'wildlife') {
                currentDatasetKey = 'wildlife';
                await ensureLoaded('wildlife');
                fillSpeciesOptions('wildlife');
            } else {
                currentDatasetKey = 'aquatic';
                await ensureLoaded('aquatic');
                fillSpeciesOptions('aquatic');
            }
            analyzeBtn.disabled = false;
        }

        function findMatchByName(list, query){
            const q = (query||'').toLowerCase().trim(); if(!q) return null;
            return list.find(r=> (r.common||'').toLowerCase().includes(q) || (r.scientific||'').toLowerCase().includes(q));
        }

        const FACTS = [
            'Healthy wetlands can store up to 10 times more carbon than forests per unit area.',
            'Wildlife corridors reduce roadkill and reconnect fragmented habitats.',
            'Over 30% of amphibians are threatened globally due to habitat loss and disease.',
            'Mangroves shield coastlines and are nurseries for many fish species.',
            'MPAs (Marine Protected Areas) can double fish biomass within a decade.'
        ];

        function showOverlay(){
            document.getElementById('loadingOverlay').style.display='flex';
            document.querySelector('.container').classList.add('blurred');
            document.getElementById('factText').textContent = FACTS[Math.floor(Math.random()*FACTS.length)];
        }
        function hideOverlay(){
            document.getElementById('loadingOverlay').style.display='none';
            document.querySelector('.container').classList.remove('blurred');
        }

        let _firstLoad = true;
        async function analyze(showLoading = true){
            if (showLoading && !_firstLoad) showOverlay();
            if (!currentDatasetKey) { hideOverlay(); return; }
            await ensureLoaded(currentDatasetKey);
            const list = datasets[currentDatasetKey];
            const speciesSel = document.getElementById('speciesSelect').value;
            let item = null;
            if (speciesSel !== 'random') item = list[parseInt(speciesSel)];
            if (!item) item = pickRandom(list);

            // simulate compute time
            if (showLoading && !_firstLoad) { await new Promise(r=>setTimeout(r, 1200)); }

            renderDetails(item);
            const series = buildSeries(item.years, item.correlation||0.6, item.population||1000);
            // Render charts immediately
            renderChart(series.labels, series.values);
            // Threat breakdown chart is already rendered in renderDetails function
            hideOverlay();
            _firstLoad = false;
        }

        // IMAGE LOOKUP: Wikipedia thumbnail fallback to Unsplash keyword
        async function wikipediaThumb(query){
            if(!query) return null;
            try {
                const res = await fetch('https://en.wikipedia.org/api/rest_v1/page/summary/' + encodeURIComponent(query));
                if(!res.ok) return null;
                const data = await res.json();
                return data && data.thumbnail && data.thumbnail.source ? data.thumbnail.source : null;
            } catch(e){ return null; }
        }

        async function getSpeciesImageUrl(item){
            const bySci = await wikipediaThumb(item.scientific);
            if (bySci) return bySci;
            const byCommon = await wikipediaThumb(item.common);
            if (byCommon) return byCommon;
            return 'https://source.unsplash.com/600x400/?' + encodeURIComponent(item.common || item.scientific || 'wildlife');
        }

        async function setSpeciesImage(item){
            const img = document.getElementById('heroImg');
            if (!img) {
                console.error('heroImg element not found');
                return;
            }
            console.log('Setting species image for:', item.common);
            img.classList.add('img-loading');
            try {
                const url = await getSpeciesImageUrl(item);
                console.log('Image URL:', url);
                return new Promise((resolve)=>{
                    const done = ()=>{ 
                        img.classList.remove('img-loading'); 
                        console.log('Image loaded successfully');
                        resolve(); 
                    };
                    img.onload = done; 
                    img.onerror = (e) => {
                        console.error('Image failed to load:', e);
                        done();
                    }; 
                    img.src = url;
                });
            } catch (error) {
                console.error('Error getting species image:', error);
                img.classList.remove('img-loading');
            }
        }

        // initial load
        (async function init(){
            try {
                console.log('Initializing dashboard...');
                // Test API connection first
                const apiWorking = await testAPI();
                console.log('API working:', apiWorking);
                
                await Promise.all([ensureLoaded('aquatic'), ensureLoaded('wildlife')]);
                console.log('Data loaded:', { aquatic: datasets.aquatic?.length, wildlife: datasets.wildlife?.length });
                populateStates();
                document.getElementById('categorySelect').value = 'wildlife';
                await onSelectionChange();
                
                // Show a random species on startup
                console.log('Loading random species on startup...');
                await analyze(false); // Load without showing loading screen
                
                // Do not auto-analyze on first load; wait for user click
                document.getElementById('stateSelect').addEventListener('change', onSelectionChange);
                document.getElementById('categorySelect').addEventListener('change', onSelectionChange);
                // Only analyze on explicit button click
                document.getElementById('analyzeBtn').addEventListener('click', function(){ analyze(true); });
                console.log('Dashboard initialized successfully');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
            }
        })();
    </script>
</body>
</html>



