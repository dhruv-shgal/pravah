<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRAVAH â€¢ Biodiversity Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f7faf9; --card: #ffffff; --text: #1f2b2a; --muted:#5c6e6b;
            --primary: #2d8659; --primary-dark:#1b5e42; --border:#e3e8e7; --subtle:#e8f3ef;
        }
        [data-theme="dark"] {
            --bg: #0a1f14; --card: #0f2a1d; --text:#e8f5e9; --muted:#b9d4c7; --border:#214a38; --subtle:#174734;
            --primary:#6ec99d; --primary-dark:#52c093;
        }
        html, body { height:100%; }
        body { font-family: 'Poppins', sans-serif; background:var(--bg); color:var(--text); }
        /* Navbar (shared) */
        .navbar { position: fixed; top:0; width:100%; background:var(--card); box-shadow:0 2px 10px rgba(0,0,0,0.05); z-index:1000; }
        .nav-container { max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; padding: 14px 24px; }
        .logo { display:flex; align-items:center; gap:8px; font-weight:700; color:var(--primary); text-decoration:none; }
        .nav-links { display:flex; gap:20px; align-items:center; list-style:none; }
        .nav-links a { color:var(--text); text-decoration:none; font-weight:500; }
        .menu-btn { display:none; width:40px; height:40px; border:1px solid var(--border); border-radius:10px; background:var(--card); align-items:center; justify-content:center; cursor:pointer; }
        .menu-icon { width:18px; height:2px; background: var(--text); position:relative; }
        .menu-icon::before, .menu-icon::after { content:""; position:absolute; left:0; width:100%; height:2px; background: var(--text); }
        .menu-icon::before { top:-6px; }
        .menu-icon::after { top:6px; }
        .nav-links a:hover { color:var(--primary); }
        .toggle-switch { position:relative; width:50px; height:26px; background:var(--muted); border-radius:30px; cursor:pointer; }
        .toggle-slider { position:absolute; top:3px; left:3px; width:20px; height:20px; background:#fff; border-radius:50%; transition: transform .25s ease; }
        .toggle-switch.active { background: var(--primary); }
        .toggle-switch.active .toggle-slider { transform: translateX(24px); }

        .container { max-width: 1200px; margin: 0 auto; padding: 24px; margin-top: 80px; }
        .nav-right { display:flex; align-items:center; gap:12px; }

        .filters { display:grid; grid-template-columns: 1fr 1fr 1.2fr auto; gap:16px; margin-top:20px; }
        .field { display:flex; flex-direction:column; gap:6px; }
        .field label { font-size:12px; color:var(--muted); font-weight:600; }
        .input, .select { width:100%; padding:12px 14px; border:1px solid var(--border); border-radius:10px; background:var(--card); color:var(--text); outline:none; }
        .btn-primary { background:var(--primary); color:#fff; border:none; padding:12px 18px; border-radius:10px; cursor:pointer; font-weight:600; }
        .btn-primary:hover { background:var(--primary-dark); }
        .grid { display:grid; grid-template-columns: 2fr 1fr; gap:20px; margin-top:20px; }
        .card { background:var(--card); border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.06); padding:18px; border:1px solid var(--border); }
        .section-title { font-weight:700; font-size:18px; margin-bottom:12px; }
        .hero-card { display:grid; grid-template-columns: 380px 1fr; gap:16px; align-items:center; }
        .hero-img { width:100%; height:240px; object-fit:contain; background: var(--subtle); border-radius:12px; transition: opacity .25s ease; }
        .hero-img.img-loading { opacity: 0.2; background: linear-gradient(90deg, var(--subtle), rgba(255,255,255,0.2), var(--subtle)); background-size: 300% 100%; animation: shimmer 1.2s infinite; }
        @keyframes shimmer { 0%{ background-position: 0% 0; } 100%{ background-position: 100% 0; } }
        .years { color:#e23d3d; font-size:44px; font-weight:800; line-height:1; }
        .muted { color:var(--muted); font-size:13px; }
        .chip { display:inline-block; background:var(--subtle); color:var(--text); padding:6px 10px; border-radius:8px; font-size:12px; margin-top:8px; }
        .key-lines { margin-top:10px; }
        .key-lines div { font-size:13px; margin-top:6px; }
        .stats { display:grid; grid-template-columns: 1fr; gap:12px; }
        .stat-row { display:flex; align-items:center; justify-content:space-between; }
        .progress { height:8px; background:var(--subtle); border-radius:999px; overflow:hidden; width:120px; margin-left:8px; }
        .progress > span { display:block; height:100%; background:var(--primary); }
        .chart-wrap { height:320px; border-radius:10px; border:1px dashed var(--border); display:flex; align-items:center; justify-content:center; padding:10px; }
        .two-col { display:grid; grid-template-columns: 1.7fr 1fr; gap:20px; margin-top:20px; }
        .list { padding-left:18px; }
        .list li { margin:8px 0; }
        .back { text-decoration:none; color:var(--primary); font-weight:600; }
        /* Loading overlay */
        .overlay { position: fixed; inset: 0; display:none; align-items:center; justify-content:center; z-index:10; backdrop-filter: blur(4px); background: rgba(0,0,0,0.15); }
        .overlay .panel { background: var(--card); color: var(--text); width:min(560px, 92vw); border-radius:16px; border:1px solid var(--border); padding:22px; box-shadow:0 24px 64px rgba(0,0,0,0.25); text-align:center; }
        .spinner { width:32px; height:32px; border-radius:50%; border:3px solid var(--subtle); border-top-color: var(--primary); margin:0 auto 14px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .fact { font-size:14px; color: var(--muted); margin-top:8px; }
        .blurred { filter: blur(3px); pointer-events:none; user-select:none; }
        @media (max-width: 900px) {
            .filters { grid-template-columns: 1fr; }
            .grid { grid-template-columns: 1fr; }
            .hero-card { grid-template-columns: 1fr; }
            .two-col { grid-template-columns: 1fr; }
        }

        @media (max-width: 768px) {
            .container { padding: 16px; margin-top: 72px; }
            .nav-links { position:absolute; top:64px; right:16px; left:16px; background:var(--card); border:1px solid var(--border); box-shadow:0 10px 30px rgba(0,0,0,0.08); border-radius:14px; padding:12px; display:none; flex-direction:column; gap:10px; z-index:1001; }
            .nav-links.show { display:flex; }
            .menu-btn { display:inline-flex; }
            .section-title { font-size: 16px; }
            .hero-img { height: 220px; }
            .years { font-size: 36px; }
            .chart-wrap { height: 260px; }
        }

        @media (max-width: 480px) {
            .logo { font-size: 0.95rem; }
            .input, .select { font-size: 14px; }
            .btn-primary { width: 100%; }
            .hero-img { height: 200px; }
            .years { font-size: 32px; }
            .chart-wrap { height: 220px; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="index.html" class="logo"><span>ðŸŒ¿</span><span>PRAVAH</span></a>
            <button class="menu-btn" id="menuBtn"><span class="menu-icon"></span></button>
            <ul class="nav-links" id="mobileMenu">
                <li><a href="index.html#home">Home</a></li>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="eco-connect.html">Eco-Connect</a></li>
                <li><a href="index.html#about">About</a></li>
                <li><a href="index.html#contact">Contact</a></li>
                <li class="toggle-container"><div class="toggle-switch" id="darkToggle"><div class="toggle-slider"></div></div></li>
            </ul>
        </div>
    </nav>
    <div class="container">

        <div class="filters">
            <div class="field">
                <label for="stateSelect">Select State</label>
                <select class="select" id="stateSelect"></select>
            </div>
            <div class="field">
                <label for="categorySelect">Vegetation</label>
                <select class="select" id="categorySelect">
                    <option value="wildlife">Wildlife</option>
                    <option value="aquatic">Aquatic</option>
                </select>
            </div>
            <div class="field">
                <label for="speciesSelect">Species</label>
                <select class="select" id="speciesSelect">
                    <option value="random">Random Species</option>
                </select>
            </div>
            <button class="btn-primary" id="analyzeBtn" disabled>Analyze Species Threat</button>
        </div>

        <div class="grid">
            <div class="card">
                <div class="section-title">Actionable Dashboard</div>
                <div class="hero-card">
                    <img class="hero-img" id="heroImg" src="https://images.unsplash.com/photo-1544551763-7ef42063f34f?q=80&w=800&auto=format&fit=crop" alt="species" />
                    <div>
                        <div style="font-weight:700; color:var(--primary); margin-bottom:6px;" id="speciesCommon">â€”</div>
                        <div class="years" id="yearsValue">â€”</div>
                        <div class="muted">Predicted Years to Extinction</div>
                        <div class="chip" id="dominantThreat">Dominant Threat: â€”</div>
                        <div class="key-lines">
                            <div><strong>Key Conservation Suggestion:</strong> <span id="suggestion">â€”</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="section-title">Species Details</div>
                <div class="stats">
                    <div class="stat-row"><span>Correlation Value</span><strong id="corrValue">â€”</strong></div>
                    <div class="stat-row"><span>Scientific Name</span><strong id="sciName">â€”</strong></div>
                    <div class="stat-row" style="gap:8px;">
                        <span>Percent Contribution</span>
                        <div class="progress"><span id="contribBar" style="width:0%"></span></div>
                        <strong id="contribNum">â€”</strong>
                    </div>
                    <div class="stat-row"><span>Current Status</span><strong id="status">â€”</strong></div>
                </div>
            </div>
        </div>

        <div class="two-col">
            <div class="card">
                <div class="section-title">Population Trend & Forecast (1970â€“2040)</div>
                <div class="chart-wrap"><canvas id="trendChart" height="280"></canvas></div>
            </div>
            <div class="card">
                <div class="section-title">Conservation Suggestions: Your Action Plan</div>
                <ul class="list" id="actionList">
                    <li>â€”</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Loading overlay -->
    <div class="overlay" id="loadingOverlay" role="alert" aria-live="polite">
        <div class="panel">
            <div class="spinner"></div>
            <div style="font-weight:700; margin-bottom:6px;">Analyzing species threatâ€¦</div>
            <div class="fact" id="factText">Crunching habitat and trend signalsâ€¦</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.umd.min.js"></script>
    <script>
        // THEME: shared with home page via localStorage 'theme'
        (function(){
            const html = document.documentElement;
            const saved = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-theme', saved);
            const t = document.getElementById('darkToggle');
            if (saved === 'dark') t.classList.add('active');
            t.addEventListener('click', function(){
                const cur = html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
                html.setAttribute('data-theme', cur); localStorage.setItem('theme', cur); this.classList.toggle('active');
                if(window._trendChart){ window._trendChart.destroy(); renderChart(_lastSeries.labels, _lastSeries.values); }
            });
            // Mobile menu
            const menuBtn = document.getElementById('menuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            menuBtn.addEventListener('click', function(){ mobileMenu.classList.toggle('show'); });
        })();

        const FILES = { aquatic: 'aquaticlife_dataset.csv', karnataka: 'karnataka_wildlife.csv' };
        const STATES = ['Andhra Pradesh','Arunachal Pradesh','Assam','Bihar','Chhattisgarh','Goa','Gujarat','Haryana','Himachal Pradesh','Jharkhand','Karnataka','Kerala','Madhya Pradesh','Maharashtra','Manipur','Meghalaya','Mizoram','Nagaland','Odisha','Punjab','Rajasthan','Sikkim','Tamil Nadu','Telangana','Tripura','Uttar Pradesh','Uttarakhand','West Bengal','Andaman & Nicobar','Chandigarh','Dadra & Nagar Haveli and Daman & Diu','Delhi','Jammu & Kashmir','Ladakh','Lakshadweep','Puducherry'];

        let datasets = { aquatic: [], karnataka: [] };
        let currentDatasetKey = 'aquatic';
        let _lastSeries = { labels: [], values: [] };

        function statusCategory(text){
            const t = (text||'').toLowerCase();
            if (t.includes('critically endangered') || t.includes('(cr)')) return 'CR';
            if (t.includes('endangered')) return 'EN';
            if (t.includes('near threatened')) return 'NT';
            if (t.includes('least concern')) return 'LC';
            if (t.includes('vulnerable')) return 'VU';
            return 'UNK';
        }

        function estimateYearsFromStatus(status){
            switch(statusCategory(status)){
                case 'CR': return 40;
                case 'EN': return 60;
                case 'VU': return 100;
                case 'NT': return 150;
                case 'LC': return 200;
                default: return 120;
            }
        }

        function estimateCorrelationFromThreat(threat, status){
            const s = statusCategory(status);
            let base = 0.5;
            if (s==='CR') base = 0.9; else if (s==='EN') base = 0.8; else if (s==='VU') base = 0.7; else if (s==='NT') base = 0.55; else if (s==='LC') base = 0.4;
            if ((threat||'').toLowerCase().includes('overfishing') || (threat||'').toLowerCase().includes('poaching')) base += 0.05;
            if ((threat||'').toLowerCase().includes('pollution')) base += 0.03;
            return Math.max(0.2, Math.min(0.98, base));
        }

        function normalizeAquatic(row){
            const status = (row['Conservation_Status']||'').replace(/\.$/, '');
            const threat = row['Dominant_Threats'] || '-';
            return {
                common: row['Common_Name'],
                scientific: row['Scientific_Name'],
                status,
                threat,
                suggestion: row['Conservation_Suggestions'] || '-',
                correlation: estimateCorrelationFromThreat(threat, status),
                years: estimateYearsFromStatus(status)
            };
        }
        function normalizeKarnataka(row){
            return {
                common: row['Species_Name'],
                scientific: row['Scientific_Name'],
                status: row['Conservation_Status'],
                threat: row['Dominant_Threat_Factor'],
                suggestion: row['Conservation_Suggestion'],
                correlation: parseFloat(row['Correlation_Value']||'0') || 0,
                years: parseInt(row['Years_Max']||'80') || 80
            };
        }

        function loadCSV(key){
            return new Promise((resolve, reject)=>{
                Papa.parse(FILES[key], {
                    download: true,
                    header: true,
                    complete: (res)=>{
                        const rows = res.data.filter(r=>Object.keys(r).length>1);
                        const normalized = key==='aquatic' ? rows.map(normalizeAquatic) : rows.map(normalizeKarnataka);
                        datasets[key] = normalized;
                        resolve(normalized);
                    },
                    error: reject
                });
            });
        }

        function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

        function fillSpeciesOptions(key){
            const sel = document.getElementById('speciesSelect');
            sel.innerHTML = '<option value="random">Random Species</option>' +
                datasets[key].slice(0,300).map((r,i)=>`<option value="${i}">${r.common}</option>`).join('');
        }

        function renderDetails(item){
            document.getElementById('yearsValue').textContent = item.years + ' YEARS';
            document.getElementById('dominantThreat').textContent = 'Dominant Threat: ' + (item.threat||'-');
            document.getElementById('suggestion').textContent = item.suggestion || '-';
            document.getElementById('corrValue').textContent = item.correlation.toFixed(2);
            document.getElementById('sciName').textContent = item.scientific || '-';
            document.getElementById('speciesCommon').textContent = item.common || 'â€”';
            document.getElementById('status').textContent = item.status || 'â€”';
            const pct = Math.max(5, Math.min(100, Math.round((item.correlation||0.5)*100)));
            document.getElementById('contribBar').style.width = pct + '%';
            document.getElementById('contribNum').textContent = pct.toFixed(1) + '%';
            const actions = (item.suggestion||'').split('. ').filter(Boolean).slice(0,3);
            const ul = document.getElementById('actionList');
            ul.innerHTML = (actions.length?actions:['â€”']).map(a=>`<li>${a.replace(/\.$/,'')}</li>`).join('');
            setSpeciesImage(item);
        }

        function buildSeries(yearsMax, correlation){
            const startYear = 1970, endYear = 2040;
            const labels = [];
            const values = [];
            const total = endYear - startYear;
            for (let i=0;i<=total;i++){
                const y = startYear + i;
                const t = i/total;
                const decline = Math.pow(1 - Math.min(0.95, correlation*0.8), t * (80/Math.max(40, Math.min(200, yearsMax))));
                const value = Math.max(5, Math.round(100*decline));
                labels.push(y);
                values.push(value);
            }
            _lastSeries = { labels, values };
            return _lastSeries;
        }

        function renderChart(labels, values){
            const ctx = document.getElementById('trendChart').getContext('2d');
            const dark = document.documentElement.getAttribute('data-theme')==='dark';
            const grid = dark ? 'rgba(185,212,199,0.12)' : 'rgba(0,0,0,0.06)';
            const text = dark ? '#b9d4c7' : '#5a6c7d';
            const border = getComputedStyle(document.documentElement).getPropertyValue('--primary').trim();
            const gradient = ctx.createLinearGradient(0,0,0,280);
            gradient.addColorStop(0, dark ? 'rgba(110,201,157,0.35)' : 'rgba(82,192,147,0.35)');
            gradient.addColorStop(1, dark ? 'rgba(27,94,66,0.05)' : 'rgba(82,192,147,0.05)');
            if (window._trendChart) window._trendChart.destroy();
            window._trendChart = new Chart(ctx, {
                type:'line',
                data:{ labels, datasets:[{ label:'Population Index', data: values, borderColor: border, borderWidth:3, pointRadius:2, pointHoverRadius:5, pointHitRadius:10, backgroundColor: gradient, tension:0.35, fill:true }]},
                options:{
                    responsive:true, maintainAspectRatio:false,
                    interaction:{ mode:'index', intersect:false },
                    scales:{ x:{ grid:{ color:grid }, ticks:{ color:text }, title:{ display:true, text:'Year', color:text, font:{ weight:'600' } } }, y:{ min:0, max:100, grid:{ color:grid, borderDash:[4,4] }, ticks:{ color:text, callback:v=>v+'%' }, title:{ display:true, text:'Population Index (%)', color:text, font:{ weight:'600' } } } },
                    plugins:{ legend:{ labels:{ color:text } }, tooltip:{ backgroundColor: dark?'rgba(20,40,32,0.9)':'rgba(255,255,255,0.95)', titleColor: dark?'#e8f5e9':'#1f2b2a', bodyColor: dark?'#b9d4c7':'#2c3e50', borderColor: grid, borderWidth:1, callbacks:{ label:(ctx)=>` ${ctx.parsed.y}% population index` } }, zoom:{ pan:{ enabled:true, mode:'xy' }, zoom:{ wheel:{ enabled:true }, pinch:{ enabled:true }, mode:'xy' }, limits:{ y:{ min:0, max:100 } } } }
                }
            });
        }

        async function ensureLoaded(key){ if (!datasets[key] || datasets[key].length===0) await loadCSV(key); }

        function populateStates(){
            const el = document.getElementById('stateSelect');
            el.innerHTML = STATES.map(s=>`<option value="${s}">${s}</option>`).join('');
            el.value = 'Karnataka';
        }

        async function onSelectionChange(){
            const state = document.getElementById('stateSelect').value;
            const category = document.getElementById('categorySelect').value; // wildlife or aquatic
            const analyzeBtn = document.getElementById('analyzeBtn');
            // Currently only Karnataka + wildlife has species CSV mapping
            if (state === 'Karnataka' && category === 'wildlife') {
                currentDatasetKey = 'karnataka';
                await ensureLoaded('karnataka');
                fillSpeciesOptions('karnataka');
                analyzeBtn.disabled = false;
            } else if (category === 'aquatic') {
                currentDatasetKey = 'aquatic';
                await ensureLoaded('aquatic');
                fillSpeciesOptions('aquatic');
                analyzeBtn.disabled = false;
            } else {
                // no data wired for other states yet
                currentDatasetKey = null;
                document.getElementById('speciesSelect').innerHTML = '<option value="random">Random Species</option>';
                analyzeBtn.disabled = true;
            }
        }

        function findMatchByName(list, query){
            const q = (query||'').toLowerCase().trim(); if(!q) return null;
            return list.find(r=> (r.common||'').toLowerCase().includes(q) || (r.scientific||'').toLowerCase().includes(q));
        }

        const FACTS = [
            'Healthy wetlands can store up to 10 times more carbon than forests per unit area.',
            'Wildlife corridors reduce roadkill and reconnect fragmented habitats.',
            'Over 30% of amphibians are threatened globally due to habitat loss and disease.',
            'Mangroves shield coastlines and are nurseries for many fish species.',
            'MPAs (Marine Protected Areas) can double fish biomass within a decade.'
        ];

        function showOverlay(){
            document.getElementById('loadingOverlay').style.display='flex';
            document.querySelector('.container').classList.add('blurred');
            document.getElementById('factText').textContent = FACTS[Math.floor(Math.random()*FACTS.length)];
        }
        function hideOverlay(){
            document.getElementById('loadingOverlay').style.display='none';
            document.querySelector('.container').classList.remove('blurred');
        }

        let _firstLoad = true;
        async function analyze(showLoading = true){
            if (showLoading && !_firstLoad) showOverlay();
            if (!currentDatasetKey) { hideOverlay(); return; }
            await ensureLoaded(currentDatasetKey);
            const list = datasets[currentDatasetKey];
            const speciesSel = document.getElementById('speciesSelect').value;
            let item = null;
            if (speciesSel !== 'random') item = list[parseInt(speciesSel)];
            if (!item) item = pickRandom(list);

            // simulate compute time
            if (showLoading && !_firstLoad) { await new Promise(r=>setTimeout(r, 1200)); }

            renderDetails(item);
            const series = buildSeries(item.years, item.correlation||0.6);
            renderChart(series.labels, series.values);
            hideOverlay();
            _firstLoad = false;
        }

        // IMAGE LOOKUP: Wikipedia thumbnail fallback to Unsplash keyword
        async function wikipediaThumb(query){
            if(!query) return null;
            try {
                const res = await fetch('https://en.wikipedia.org/api/rest_v1/page/summary/' + encodeURIComponent(query));
                if(!res.ok) return null;
                const data = await res.json();
                return data && data.thumbnail && data.thumbnail.source ? data.thumbnail.source : null;
            } catch(e){ return null; }
        }

        async function getSpeciesImageUrl(item){
            const bySci = await wikipediaThumb(item.scientific);
            if (bySci) return bySci;
            const byCommon = await wikipediaThumb(item.common);
            if (byCommon) return byCommon;
            return 'https://source.unsplash.com/600x400/?' + encodeURIComponent(item.common || item.scientific || 'wildlife');
        }

        async function setSpeciesImage(item){
            const img = document.getElementById('heroImg');
            img.classList.add('img-loading');
            const url = await getSpeciesImageUrl(item);
            return new Promise((resolve)=>{
                const done = ()=>{ img.classList.remove('img-loading'); resolve(); };
                img.onload = done; img.onerror = done; img.src = url;
            });
        }

        // initial load
        (async function init(){
            await Promise.all([ensureLoaded('aquatic'), ensureLoaded('karnataka')]);
            populateStates();
            document.getElementById('categorySelect').value = 'wildlife';
            await onSelectionChange();
            // Do not auto-analyze on first load; wait for user click
            document.getElementById('stateSelect').addEventListener('change', onSelectionChange);
            document.getElementById('categorySelect').addEventListener('change', onSelectionChange);
            // Only analyze on explicit button click
            document.getElementById('analyzeBtn').addEventListener('click', function(){ analyze(true); });
        })();
    </script>
</body>
</html>



